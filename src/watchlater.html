<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Watch Later - Solace</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      /* Theme Variables - Matching main site */
      :root {
        --primary-color: #8b5cf6;
        --primary-light: #a78bfa;
        --primary-dark: #7c3aed;
        --secondary-color: #4c1d95;
        --text-color: #1f2937;
        --background-color: #f9fafb;
        --card-background: #ffffff;
        --navbar-background: #1e1b4b;
        --input-background: #ffffff;
        --input-text: #1f2937;
        --border-color: #e5e7eb;
        --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      }

      /* Dark Theme */
      [data-theme='dark'] {
        --primary-color: #a78bfa;
        --primary-light: #8b5cf6;
        --primary-dark: #7c3aed;
        --secondary-color: #4c1d95;
        --text-color: #f3f4f6;
        --background-color: #111827;
        --card-background: #1f2937;
        --navbar-background: #0f172a;
        --input-background: #374151;
        --input-text: #f3f4f6;
        --border-color: #374151;
      }

      body {
        font-family: 'Poppins', sans-serif;
        margin: 0;
        padding: 0;
        background-color: var(--background-color);
        color: var(--text-color);
        min-height: 100vh;
      }

      .navbar {
        background-color: var(--navbar-background);
        padding: 1rem 0;
        position: sticky;
        top: 0;
        z-index: 100;
        box-shadow: var(--shadow-md);
      }

      .navbar-content {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .navbar-logo {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: white;
        text-decoration: none;
        font-weight: 600;
        font-size: 1.1rem;
      }

      .navbar-actions {
        display: flex;
        gap: 1rem;
      }

      .container {
        max-width: 1200px;
        margin: 2rem auto;
        padding: 0 1rem;
      }

      .header {
        background: var(--card-background);
        padding: 1.5rem;
        border-radius: 12px;
        margin-bottom: 2rem;
        box-shadow: var(--shadow-md);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .header h1 {
        margin: 0;
        font-size: 1.8rem;
        color: var(--text-color);
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .header-actions {
        display: flex;
        gap: 1rem;
        align-items: center;
      }

      .btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        background: var(--primary-color);
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .btn:hover {
        background: var(--primary-dark);
        transform: translateY(-1px);
      }

      .btn.btn-secondary {
        background: var(--card-background);
        color: var(--text-color);
        border: 1px solid var(--border-color);
      }

      .btn.btn-secondary:hover {
        background: var(--background-color);
      }

      .btn.btn-danger {
        background: #ef4444;
      }

      .btn.btn-danger:hover {
        background: #dc2626;
      }

      .select {
        padding: 0.75rem;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        background: var(--input-background);
        color: var(--text-color);
        font-size: 1rem;
        cursor: pointer;
        min-width: 200px;
      }

      .select:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
      }

      .video-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
      }

      .video-card {
        background: var(--card-background);
        border-radius: 12px;
        overflow: hidden;
        box-shadow: var(--shadow-md);
        transition: all 0.3s ease;
        position: relative;
      }

      .video-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-lg);
      }

      .video-thumbnail {
        position: relative;
        padding-top: 56.25%;
        background: #f0f0f0;
        cursor: pointer;
      }

      .video-thumbnail img {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .video-duration {
        position: absolute;
        bottom: 8px;
        right: 8px;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 0.8rem;
      }

      .video-info {
        padding: 1rem;
      }

      .video-title {
        font-size: 1.1rem;
        font-weight: 600;
        margin: 0 0 0.5rem 0;
        color: var(--text-color);
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }

      .video-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        font-size: 0.9rem;
        color: var(--text-color);
        opacity: 0.8;
        margin-bottom: 0.5rem;
      }

      .video-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-top: 0.5rem;
        border-top: 1px solid var(--border-color);
      }

      .added-time {
        font-size: 0.8rem;
        color: var(--text-color);
        opacity: 0.7;
      }

      .btn-icon {
        background: none;
        border: none;
        color: var(--text-color);
        cursor: pointer;
        padding: 0.5rem;
        border-radius: 6px;
        transition: all 0.2s;
      }

      .btn-icon:hover {
        background: rgba(0, 0, 0, 0.05);
        color: #ef4444;
      }

      .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        background: var(--card-background);
        border-radius: 12px;
        margin: 2rem 0;
      }

      .empty-state i {
        font-size: 3rem;
        color: var(--primary-color);
        margin-bottom: 1rem;
      }

      .empty-state h2 {
        margin: 1rem 0;
        color: var(--text-color);
      }

      .empty-state p {
        color: var(--text-color);
        opacity: 0.8;
        margin-bottom: 2rem;
      }

      .loading {
        text-align: center;
        padding: 4rem 2rem;
      }

      .loading-spinner {
        border: 4px solid var(--border-color);
        border-top: 4px solid var(--primary-color);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      .notification {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: var(--primary-color);
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 8px;
        box-shadow: var(--shadow-lg);
        animation: slideIn 0.3s ease-out;
        z-index: 1000;
      }

      @keyframes slideIn {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      @media (max-width: 768px) {
        .header {
          flex-direction: column;
          gap: 1rem;
          align-items: stretch;
        }

        .header-actions {
          flex-direction: column;
        }

        .video-grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <nav class="navbar">
      <div class="navbar-content">
        <a href="community-exploration.html" class="navbar-logo">
          <i class="fas fa-arrow-left"></i>
          Back to Videos
        </a>
        <div class="navbar-actions">
          <button class="btn btn-danger" id="clear-all" title="Clear All">
            <i class="fas fa-trash"></i>
            Clear All
          </button>
        </div>
      </div>
    </nav>

    <div class="container">
      <div class="header">
        <h1>
          <i class="fas fa-clock"></i>
          Watch Later
        </h1>
        <div class="header-actions">
          <select id="sort-select" class="select">
            <option value="date-added-desc">Recently Added</option>
            <option value="date-added-asc">Oldest Added</option>
            <option value="title">Title A-Z</option>
            <option value="duration">Duration</option>
          </select>
        </div>
      </div>

      <div id="videos-grid" class="video-grid">
        <!-- Videos will be loaded here -->
      </div>

      <div id="loading" class="loading" style="display: none">
        <div class="loading-spinner"></div>
        <p>Loading your saved videos...</p>
      </div>

      <div id="empty-state" class="empty-state" style="display: none">
        <i class="fas fa-clock"></i>
        <h2>Your Watch Later list is empty</h2>
        <p>Save videos to watch them later. They'll appear here for easy access.</p>
        <button class="btn" onclick="window.location.href='community-exploration.html'">
          Browse Videos
        </button>
      </div>
    </div>

    <script type="module">
      // Import Firebase modules
      import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
      import { getAuth } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
      import { getDatabase, ref, get, set, remove } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js';

      const firebaseConfig = {
        apiKey: 'AIzaSyA3V8kM0CKK5SiQGu1EOaV7kCeowl1cRCI',
        authDomain: 'solace-83466.firebaseapp.com',
        databaseURL: 'https://solace-83466-default-rtdb.firebaseio.com',
        projectId: 'solace-83466',
        storageBucket: 'solace-83466.appspot.com',
        messagingSenderId: '1035507922270',
        appId: '1:1035507922270:web:496b548ba710523eb18bcf',
        measurementId: 'G-H8RRCK340M',
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const database = getDatabase(app);

      let watchLaterVideos = [];

      function showLoading(show = true) {
        document.getElementById('loading').style.display = show ? 'block' : 'none';
        document.getElementById('videos-grid').style.display = show ? 'none' : 'grid';
        document.getElementById('empty-state').style.display = 'none';
      }

      function showEmptyState(show = true) {
        document.getElementById('empty-state').style.display = show ? 'block' : 'none';
        document.getElementById('videos-grid').style.display = show ? 'none' : 'grid';
        document.getElementById('loading').style.display = 'none';
      }

      function showNotification(message, type = 'success') {
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.textContent = message;
        document.body.appendChild(notification);

        setTimeout(() => {
          notification.remove();
        }, 3000);
      }

      function formatDuration(duration) {
        if (!duration) return '';

        const match = duration.match(/PT(\d+H)?(\d+M)?(\d+S)?/);
        if (!match) return '';

        const hours = (match[1] || '0H').slice(0, -1);
        const minutes = (match[2] || '0M').slice(0, -1);
        const seconds = (match[3] || '0S').slice(0, -1);

        let formattedDuration = '';

        if (hours !== '0') {
          formattedDuration += `${hours}:`;
        }

        formattedDuration += `${minutes.padStart(2, '0')}:${seconds.padStart(2, '0')}`;

        return formattedDuration;
      }

      function formatTimeAgo(timestamp) {
        const date = new Date(timestamp);
        const now = new Date();
        const diff = now - date;

        const minutes = Math.floor(diff / 60000);
        const hours = Math.floor(minutes / 60);
        const days = Math.floor(hours / 24);

        if (days > 0) return `${days} day${days === 1 ? '' : 's'} ago`;
        if (hours > 0) return `${hours} hour${hours === 1 ? '' : 's'} ago`;
        if (minutes > 0) return `${minutes} minute${minutes === 1 ? '' : 's'} ago`;
        return 'just now';
      }

      function createVideoCard(video) {
        return `
          <div class="video-card" data-video-id="${video.id}">
            <div class="video-thumbnail" onclick="window.open('https://www.youtube.com/watch?v=${video.id}', '_blank')">
              <img src="${video.thumbnail}" alt="${video.title}" loading="lazy">
              ${video.duration ? `<span class="video-duration">${formatDuration(video.duration)}</span>` : ''}
            </div>
            <div class="video-info">
              <h3 class="video-title">${video.title}</h3>
              <div class="video-meta">
                <span><i class="fas fa-user"></i> ${video.channelTitle}</span>
                ${video.viewCount ? `<span><i class="fas fa-eye"></i> ${parseInt(video.viewCount).toLocaleString()} views</span>` : ''}
              </div>
              <div class="video-actions">
                <span class="added-time">Added ${formatTimeAgo(video.addedAt)}</span>
                <button class="btn-icon" onclick="removeFromWatchLater('${video.id}', event)" title="Remove from Watch Later">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </div>
          </div>
        `;
      }

      async function loadWatchLaterVideos() {
        const user = auth.currentUser;
        if (!user) {
          window.location.href = 'login.html';
          return;
        }

        showLoading(true);

        try {
          const watchLaterRef = ref(database, `users/${user.uid}/watchLater`);
          const videosRef = ref(database, 'videos');

          const [watchLaterSnapshot, videosSnapshot] = await Promise.all([
            get(watchLaterRef),
            get(videosRef),
          ]);

          const watchLater = watchLaterSnapshot.val() || {};
          const allVideos = videosSnapshot.val() || {};

          watchLaterVideos = Object.entries(watchLater)
            .map(([videoId, data]) => ({
              ...allVideos[videoId],
              addedAt: data.addedAt,
              id: videoId,
            }))
            .filter(video => video.title); // Filter out any missing videos

          sortVideos(document.getElementById('sort-select').value);
          
          if (watchLaterVideos.length === 0) {
            showEmptyState(true);
          } else {
            displayVideos();
          }
        } catch (error) {
          console.error('Error loading watch later videos:', error);
          showNotification('Error loading videos. Please try again.', 'error');
        } finally {
          showLoading(false);
        }
      }

      function sortVideos(sortBy) {
        switch (sortBy) {
          case 'date-added-desc':
            watchLaterVideos.sort((a, b) => new Date(b.addedAt) - new Date(a.addedAt));
            break;
          case 'date-added-asc':
            watchLaterVideos.sort((a, b) => new Date(a.addedAt) - new Date(b.addedAt));
            break;
          case 'title':
            watchLaterVideos.sort((a, b) => a.title.localeCompare(b.title));
            break;
          case 'duration':
            watchLaterVideos.sort((a, b) => {
              const durationA = a.duration ? parseDuration(a.duration) : 0;
              const durationB = b.duration ? parseDuration(b.duration) : 0;
              return durationB - durationA;
            });
            break;
        }
        displayVideos();
      }

      function parseDuration(duration) {
        if (!duration) return 0;
        const match = duration.match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/);
        if (!match) return 0;

        const hours = parseInt(match[1] || '0') * 3600;
        const minutes = parseInt(match[2] || '0') * 60;
        const seconds = parseInt(match[3] || '0');

        return hours + minutes + seconds;
      }

      function displayVideos() {
        const grid = document.getElementById('videos-grid');
        
        if (watchLaterVideos.length === 0) {
          showEmptyState(true);
          return;
        }

        grid.innerHTML = watchLaterVideos.map(video => createVideoCard(video)).join('');
      }

      // Make removeFromWatchLater available globally
      window.removeFromWatchLater = async function(videoId, event) {
        event.stopPropagation();
        
        if (!confirm('Remove this video from Watch Later?')) return;

        const user = auth.currentUser;
        if (!user) return;

        try {
          await remove(ref(database, `users/${user.uid}/watchLater/${videoId}`));
          
          // Remove from local array
          watchLaterVideos = watchLaterVideos.filter(v => v.id !== videoId);
          
          // Animate removal
          const card = event.target.closest('.video-card');
          card.style.transition = 'all 0.3s ease';
          card.style.opacity = '0';
          card.style.transform = 'scale(0.9)';
          
          setTimeout(() => {
            if (watchLaterVideos.length === 0) {
              showEmptyState(true);
            } else {
              displayVideos();
            }
          }, 300);

          showNotification('Video removed from Watch Later');
        } catch (error) {
          console.error('Error removing video:', error);
          showNotification('Error removing video. Please try again.', 'error');
        }
      };

      // Clear all handler
      document.getElementById('clear-all').addEventListener('click', async () => {
        if (!confirm('Are you sure you want to clear your entire Watch Later list?')) return;

        const user = auth.currentUser;
        if (!user) return;

        try {
          await remove(ref(database, `users/${user.uid}/watchLater`));
          watchLaterVideos = [];
          showEmptyState(true);
          showNotification('Watch Later list cleared');
        } catch (error) {
          console.error('Error clearing watch later:', error);
          showNotification('Error clearing list. Please try again.', 'error');
        }
      });

      // Sort handler
      document.getElementById('sort-select').addEventListener('change', (e) => {
        sortVideos(e.target.value);
      });

      // Initialize
      auth.onAuthStateChanged((user) => {
        if (user) {
          loadWatchLaterVideos();
        } else {
          window.location.href = 'login.html';
        }
      });
    </script>
  </body>
</html>