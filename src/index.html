<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Solace: A platform designed to help individuals with ADHD through educational content, tips, and resources. Explore, learn, and stay organized.">
    <meta name="keywords" content="ADHD, tips, ADHD education, motivation, lifestyle, ADHD strategies, mental health, ADHD resources">
    <meta name="author" content="Solace Team">
  <title>Solace ADHD</title>

  <link rel="icon" type="image/x-icon" href="./assets/favicon-16x16.png">

  <meta name="description" content="Access a curated collection of user posted ADHD resources to support your journey, also with AI funtionality.">

    <meta property="og:title" content="Solace - Your ADHD Companion">
    <meta property="og:description" content="Explore user posted content, strategies, and tips for ADHD. Designed for children, teens, and adults with ADHD.">
    <meta property="og:image" content="https://solaceadhd.com/assets/og-image.jpg">
    <meta property="og:url" content="https://solaceadhd.com">
    <meta property="og:type" content="website">

    <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Solace - Your ADHD Companion">
  <meta name="twitter:description" content="Explore ADHD-focused content and strategies on Solace. Stay motivated, learn, and find the support you need.">
  <meta name="twitter:image" content="https://solaceadhd.com/assets/og-image.jpg">
  <!-- Load Tailwind first -->
  <link href="./output.css" rel="stylesheet">

  <script src="./env.js"></script>
  
  <!-- Load Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-storage-compat.js"></script>
  
  <!-- Load React -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <link href="https://api.fontshare.com/v2/css?f[]=satoshi@900,700,500,300,400&display=swap" rel="stylesheet">

  <!-- Google tag (gtag.js) --> <script async src="https://www.googletagmanager.com/gtag/js?id=AW-16832194187"> </script> 
  <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'AW-16832194187'); </script>
  <!-- Event snippet for Page view conversion page --> <script> gtag('event', 'conversion', { 'send_to': 'AW-16832194187/zpHwCI_sopMaEIvNm9o-', 'value': 1.0, 'currency': 'USD' }); </script>
</head>
<style>
  /* Enhanced animations */
  @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .card-hover {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .card-hover:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    }

    /* Smooth transitions */
    .smooth-transition {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

  .fade-in {
    animation: fadeIn 0.5s ease-out;
  }
@keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    50% { transform: translateX(5px); }
    75% { transform: translateX(-5px); }
}

.animate-shake {
    animation: shake 0.5s ease-in-out;
}

@keyframes confetti-fall {
    0% { transform: translateY(-100vh) rotate(0deg); }
    100% { transform: translateY(100vh) rotate(360deg); }
}

input:focus, textarea:focus {
    border-color: #58A6FF;
    box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.3);
    transition: all 0.3s ease-in-out;
}

button:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    transition: all 0.2s ease-in-out;
}

/* Mobile Navigation Styles */
.mobile-nav {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  padding: 0.5rem;
  background: #0D1117;
  border-top: 1px solid rgba(48, 54, 61, 0.4);
  z-index: 50;
  display: flex;
  justify-content: space-around;
}

@media (min-width: 1024px) {
  .mobile-nav {
    position: fixed;
    left: 0;
    top: 0;
    bottom: 0;
    width: 4rem;
    flex-direction: column;
    border-top: none;
    border-right: 1px solid rgba(48, 54, 61, 0.4);
  }
}

/* Responsive Container */
.content-container {
  padding: 1rem;
  margin-bottom: 4rem; /* Space for mobile nav */
}

@media (min-width: 1024px) {
  .content-container {
    margin-left: 4rem;
    margin-bottom: 0;
    padding: 2rem;
  }
}

/* Card Grid Responsiveness */
.resource-grid {
  display: grid;
  gap: 1rem;
  grid-template-columns: 1fr;
}

@media (min-width: 640px) {
  .resource-grid {
    grid-template-columns: repeat(2, 1fr);
  }
}

@media (min-width: 1024px) {
  .resource-grid {
    grid-template-columns: repeat(3, 1fr);
  }
}

/* Responsive Container */
.content-container {
  padding: 1rem;
  margin-bottom: 4rem; /* Space for mobile nav */
}

@media (min-width: 1024px) {
  .content-container {
    margin-left: 4rem;
    margin-bottom: 0;
    padding: 2rem;
  }
}

/* Card Grid Responsiveness */
.resource-grid {
  display: grid;
  gap: 1rem;
  grid-template-columns: 1fr;
}

@media (min-width: 640px) {
  .resource-grid {
    grid-template-columns: repeat(2, 1fr);
  }
}

@media (min-width: 1024px) {
  .resource-grid {
    grid-template-columns: repeat(3, 1fr);
  }
}

/* Better Touch Targets */
.touch-target {
  min-height: 44px;
  min-width: 44px;
  padding: 0.75rem;
}

/* Touch Feedback */
.touch-feedback {
  position: relative;
  overflow: hidden;
}

.touch-feedback::after {
  content: '';
  position: absolute;
  inset: 0;
  background: currentColor;
  opacity: 0;
  transition: opacity 0.2s;
}

.touch-feedback:active::after {
  opacity: 0.1;
}

/* Mobile-Friendly Inputs */
input, textarea, select {
  font-size: 16px; /* Prevents iOS zoom */
  padding: 0.75rem;
  border-radius: 0.5rem;
  width: 100%;
  -webkit-appearance: none;
}

/* Custom Select Styling */
.custom-select {
  position: relative;
  display: block;
}

.custom-select select {
  padding-right: 2rem;
  background-image: url("data:image/svg+xml,...");
  background-position: right 0.5rem center;
  background-repeat: no-repeat;
}

/* Mobile Modal Layout */
.modal-container {
  padding: 1rem;
  max-height: 90vh;
  width: 100%;
  margin: 1rem;
  border-radius: 1rem;
}

@media (min-width: 640px) {
  .modal-container {
    max-width: 28rem;
    margin: 0 auto;
  }
}

/* Bottom Sheet Style for Mobile */
.bottom-sheet {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: #0D1117;
  border-radius: 1rem 1rem 0 0;
  transform: translateY(100%);
  transition: transform 0.3s ease-out;
}

.bottom-sheet.active {
  transform: translateY(0);
}

@keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    50% { transform: translateX(5px); }
    75% { transform: translateX(-5px); }
}

.animate-shake {
    animation: shake 0.5s ease-in-out;
}

@keyframes confetti-fall {
    0% { transform: translateY(-100vh) rotate(0deg); }
    100% { transform: translateY(100vh) rotate(360deg); }
}

.confetti-animation {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 1000;
    animation: confetti-fall 3s linear forwards;
}


</style>
<body>
    <div id="root"></div>

    <script type="text/babel" type="module">


    // Firebase configuration
    const firebaseConfig = {
        apiKey: 'AIzaSyA3V8kM0CKK5SiQGu1EOaV7kCeowl1cRCI',
        authDomain: 'solace-83466.firebaseapp.com',
        databaseURL: 'https://solace-83466-default-rtdb.firebaseio.com',
        projectId: 'solace-83466',
        storageBucket: 'solace-83466.appspot.com',
        messagingSenderId: '1035507922270',
        appId: '1:1035507922270:web:496b548ba710523eb18bcf',
        measurementId: 'G-H8RRCK340M',
    };
    
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }

    const auth = firebase.auth();
    const db = firebase.database();
    const storage = firebase.storage();
    const googleProvider = new firebase.auth.GoogleAuthProvider();

    const HF_API_KEY = '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';

    class ErrorBoundary extends React.Component {
    constructor(props) {
        super(props);
        this.state = { hasError: false };
    }

    static getDerivedStateFromError(error) {
        return { hasError: true };
    }

    componentDidCatch(error, errorInfo) {
        console.error("Error caught by error boundary:", error, errorInfo);
    }

    render() {
        if (this.state.hasError) {
            return <div className="text-red-500 p-4">Something went wrong. Please try again later.</div>;
        }
        return this.props.children;
    }
}


    // Constants
    const RESOURCE_CATEGORIES = [
        { id: 'productivity', label: 'Productivity', icon: 'âš¡' },
        { id: 'study', label: 'Study', icon: 'ðŸ“š' },
        { id: 'work', label: 'Work', icon: 'ðŸ’¼' },
        { id: 'health', label: 'Health', icon: 'ðŸŒ±' },
        { id: 'routine', label: 'Routine', icon: 'â°' },
        { id: 'focus', label: 'Focus', icon: 'ðŸŽ¯' }
    ];

    const QUICK_TIPS = [
        'Set a 3-minute timer to break down your task',
        'Write down just THREE things to do today',
        'Take a quick movement break',
        'Drink some water and stretch',
        'Clear one small space near you',
        'Put on focus music for 25 minutes'
    ];

    const colors = {
        bg: {
            primary: "bg-[#0D1117]", // Dark base
            secondary: "bg-[#161B22]", // Slightly lighter for cards
            accent: "bg-[#21262D]", // For interactive elements
        },
        text: {
            primary: "text-[#E6EDF3]", // Soft white for readability
            secondary: "text-[#8B949E]", // Muted text for less important info
            accent: "text-[#58A6FF]", // Vibrant blue for links and buttons
        },
        border: "border-[#30363D]", // Subtle borders
        button: {
            primary: "bg-[#238636] hover:bg-[#2EA043]", // Green for primary actions
            secondary: "bg-[#21262D] hover:bg-[#30363D]", // Dark for secondary actions
            glow: "shadow-[0_0_8px_rgba(88,166,255,0.6)]", // Glow effect for buttons
        },
    };

    function getDefaultStrategies() {
  return [
    {
      id: 'default-1-' + Date.now(),
      title: 'The Pomodoro Technique',
      description: '1. Choose one specific subject to study\n2. Set a timer for 25 minutes\n3. Study with complete focus until the timer rings\n4. Take a 5-minute break\n5. After 4 cycles, take a longer 15-30 minute break\n\nThis technique helps maintain focus and prevents burnout by breaking study sessions into manageable chunks.',
      timeToComplete: '25 minutes per session',
      tags: ['Time Management', 'Focus'],
      progress: 0,
      postedBy: 'AI Assistant',
      likes: 0,
      liked: false
    },
    {
      id: 'default-2-' + Date.now(),
      title: 'Active Recall Method',
      description: '1. Read a section of your study material\n2. Close the book or notes\n3. Write down everything you remember\n4. Check your notes for accuracy\n5. Focus on areas you missed\n\nActive recall is one of the most effective study techniques, especially for ADHD learners, as it keeps your mind actively engaged.',
      timeToComplete: '15 minutes per topic',
      tags: ['Study Skills', 'Memory'],
      progress: 0,
      postedBy: 'AI Assistant',
      likes: 0,
      liked: false
    },
    {
      id: 'default-3-' + Date.now(),
      title: 'Body Doubling Study Session',
      description: '1. Find a study buddy or join an online study room\n2. Share your study goals for the session\n3. Study in parallel with others\n4. Take synchronized breaks\n5. Share progress at the end\n\nBody doubling (studying in the presence of others) can help maintain focus and accountability.',
      timeToComplete: '1 hour',
      tags: ['Accountability', 'Social Learning'],
      progress: 0,
      postedBy: 'AI Assistant',
      likes: 0,
      liked: false
    }
  ];
}

    const ProgressBar = ({ progress }) => (
        <div className="w-full bg-gray-200 rounded-full h-2">
            <div
                className="bg-[#58A6FF] h-2 rounded-full"
                style={{ width: `${progress}%` }}
            />
        </div>
    );

    const loadUserData = async (userId) => {
    try {
        const snapshot = await firebase.database().ref(`users/${userId}`).once('value');
        const userData = snapshot.val();
        setUserProfile(userData || { username: 'User', resourcesShared: 0, resourcesCompleted: 0 });
    } catch (error) {
        console.error('Error loading user data:', error);
    }
};

    const NavigationIcons = {
        Home: () => (
            <svg className="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
            </svg>
        ),
        Discover: () => (
            <svg className="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
        ),
        Create: () => (
            <svg className="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M12 4v16m8-8H4" />
            </svg>
        ),
        Profile: () => (
            <svg className="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
            </svg>
        )
    };

    // Utility Components
    const LoadingSpinner = () => (
        <div className="flex justify-center items-center">
            <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-purple-500"></div>
        </div>
    );

    // Auth Components
    const AuthModal = ({ onClose, isLogin = true }) => {
    const [email, setEmail] = React.useState('');
    const [password, setPassword] = React.useState('');
    const [error, setError] = React.useState('');
    const [loading, setLoading] = React.useState(false);
    const googleProvider = new firebase.auth.GoogleAuthProvider();

    const handleAuth = async (e) => {
        e.preventDefault();
        setLoading(true);
        setError('');

        try {
            if (isLogin) {
                await auth.signInWithEmailAndPassword(email, password);
            } else {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                await firebase.database().ref(`users/${user.uid}`).set({
                    username: email.split('@')[0],
                    email: email,
                    resourcesShared: 0,
                    resourcesCompleted: 0,
                    createdAt: firebase.database.ServerValue.TIMESTAMP
                });
            }
            onClose();
        } catch (error) {
            setError(error.message);
        } finally {
            setLoading(false);
        }
    };

    const handleGoogleSignIn = async () => {
        setLoading(true);
        setError('');
        
        try {
            const result = await auth.signInWithPopup(googleProvider);
            const user = result.user;
            
            const userRef = firebase.database().ref(`users/${user.uid}`);
            const snapshot = await userRef.once('value');
            
            if (!snapshot.exists()) {
                await userRef.set({
                    username: user.displayName || user.email.split('@')[0],
                    email: user.email,
                    avatar_url: user.photoURL,
                    resourcesShared: 0,
                    resourcesCompleted: 0,
                    createdAt: firebase.database.ServerValue.TIMESTAMP
                });
            }
            onClose();
        } catch (error) {
            setError(error.message);
        } finally {
            setLoading(false);
        }
    };

    return (
        <div className="fixed inset-0 bg-[#0D1117]/95 z-50 flex items-center justify-center p-4 backdrop-blur-xl">
            <div className={`${colors.bg.secondary} rounded-xl p-8 max-w-md w-full border ${colors.border}`}>
                <div className="flex justify-between items-center mb-6">
                    <h2 className="text-xl font-semibold text-[#58A6FF]">
                        {isLogin ? 'Welcome Back' : 'Join SolaceADHD'}
                    </h2>
                    <button onClick={onClose} className="text-[#8B949E] hover:text-[#C9D1D9]">
                        âœ•
                    </button>
                </div>

                <form className="space-y-4" onSubmit={handleAuth}>
                    <input
                        type="email"
                        placeholder="Email"
                        value={email}
                        onChange={(e) => setEmail(e.target.value)}
                        className={`w-full p-3 ${colors.bg.accent} rounded-lg border ${colors.border} 
                            ${colors.text.primary} focus:border-[#58A6FF]/30 transition-all duration-300`}
                        required
                    />
                    <input
                        type="password"
                        placeholder="Password"
                        value={password}
                        onChange={(e) => setPassword(e.target.value)}
                        className={`w-full p-3 ${colors.bg.accent} rounded-lg border ${colors.border} 
                            ${colors.text.primary} focus:border-[#58A6FF]/30 transition-all duration-300`}
                        required
                    />
                    
                    {error && <p className="text-red-500 text-sm">{error}</p>}
                    
                    <button 
                        type="submit" 
                        disabled={loading}
                        className="w-full bg-[#58A6FF] text-white py-3 rounded-lg hover:bg-[#58A6FF]/90 
                            transition-all duration-300 disabled:opacity-50"
                    >
                        {loading ? 'Processing...' : (isLogin ? 'Login' : 'Create Account')}
                    </button>
                </form>

                <div className="relative my-6">
                    <div className="absolute inset-0 flex items-center">
                        <div className="w-full border-t border-gray-700"></div>
                    </div>
                    <div className="relative flex justify-center text-sm">
                        <span className={`px-2 ${colors.bg.secondary} ${colors.text.secondary}`}>
                            Or continue with
                        </span>
                    </div>
                </div>

                <button
                    onClick={handleGoogleSignIn}
                    disabled={loading}
                    className="w-full flex items-center justify-center gap-3 px-4 py-3 
                        border border-gray-700 rounded-lg hover:bg-gray-800 transition-colors
                        disabled:opacity-50"
                >
                    <img src="https://www.google.com/favicon.ico" alt="Google" className="w-5 h-5" />
                    <span className={colors.text.primary}>
                        {isLogin ? 'Sign in with Google' : 'Sign up with Google'}
                    </span>
                </button>
            </div>
        </div>
    );
};


const handleGoogleSignIn = async () => {
    try {
        const result = await auth.signInWithPopup(googleProvider);
        const user = result.user;
        
        // Check if this is a new user
        const userRef = firebase.database().ref(`users/${user.uid}`);
        const snapshot = await userRef.once('value');
        
        if (!snapshot.exists()) {
            // Create new user profile
            await userRef.set({
                username: user.displayName || user.email.split('@')[0],
                email: user.email,
                avatar_url: user.photoURL,
                resourcesShared: 0,
                resourcesCompleted: 0,
                createdAt: firebase.database.ServerValue.TIMESTAMP
            });
        }
    } catch (error) {
        console.error('Google sign in error:', error);
        setError(error.message);
    }
};


    // Navigation Component
    const Navigation = ({ currentPage, setCurrentPage }) => {
  const navItems = [
    {
      icon: <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
      </svg>,
      id: 'main',
      label: 'Home'
    },
    {
      icon: <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
      </svg>,
      id: 'discover',
      label: 'Discover'
    },
    {
      icon: <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M12 4v16m8-8H4" />
      </svg>,
      id: 'post',
      label: 'Post'
    },
    {
      icon: <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
      </svg>,
      id: 'profile',
      label: 'Profile'
    }
  ];

  return (
    <nav className="fixed lg:left-0 lg:top-0 lg:h-full lg:w-16 
                    bottom-0 left-0 right-0 w-full
                    bg-[#0D1117] border-t lg:border-r lg:border-t-0 border-gray-800/40
                    z-50 transition-all">
      <div className="h-full">
        <div className="flex lg:flex-col lg:h-full items-center justify-center gap-1 lg:gap-8 px-2 py-2 lg:py-8">
          {navItems.map(({ icon, id, label }) => (
            <button
              key={id}
              onClick={() => setCurrentPage(id)}
              className={`relative group flex lg:flex-col items-center gap-2 
                         min-w-[64px] lg:min-w-0 px-3 py-2.5 lg:p-3
                         transition-all duration-200 
                         ${currentPage === id 
                           ? 'text-purple-400' 
                           : 'text-gray-500 hover:text-gray-300'}`}
            >
              {/* Icon */}
              <div className={`transition-transform duration-200 
                            ${currentPage === id 
                              ? 'scale-110 transform' 
                              : 'group-hover:scale-105'}`}>
                {icon}
              </div>
              
              {/* Label */}
              <span className={`text-xs font-medium transition-colors duration-200
                              lg:opacity-0 lg:group-hover:opacity-100 lg:absolute lg:left-20 
                              lg:bg-gray-900 lg:text-gray-100 lg:px-2.5 lg:py-1.5 lg:rounded-md
                              lg:whitespace-nowrap lg:before:absolute lg:before:w-2 lg:before:h-2 
                              lg:before:bg-gray-900 lg:before:rounded-sm lg:before:rotate-45
                              lg:before:-left-1 lg:before:top-1/2 lg:before:-translate-y-1/2`}>
                {label}
              </span>

              {/* Active indicator */}
              {currentPage === id && (
                <>
                  {/* Mobile indicator */}
                  <div className="absolute -bottom-2 left-1/2 -translate-x-1/2 w-8 h-1 
                                 bg-purple-400 rounded-full lg:hidden" />
                  
                  {/* Desktop indicator */}
                  <div className="hidden lg:block absolute left-0 top-1/2 -translate-y-1/2 
                                 w-0.5 h-5 bg-purple-400 rounded-full" />
                </>
              )}
            </button>
          ))}
        </div>
      </div>
    </nav>
  );
};

const moderateContent = async (content) => {
    // Using HuggingFace API for content moderation
    const response = await fetch("https://api-inference.huggingface.co/models/facebook/roberta-hate-speech-dynabench-r4-target", {
        method: "POST",
        headers: {
            "Authorization": `Bearer ${HF_API_KEY}`,
            "Content-Type": "application/json"
        },
        body: JSON.stringify({ inputs: content })
    });
    return await response.json();
};

const validateContent = async (content) => {
    try {
        // Add error handling for empty content
        if (!content || content.trim().length === 0) {
            throw new Error("Content cannot be empty");
        }

        const response = await fetch("https://api-inference.huggingface.co/models/facebook/roberta-hate-speech-dynabench-r4-target", {
            method: "POST",
            headers: {
                "Authorization": `Bearer ${HF_API_KEY}`,
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ 
                inputs: content,
                options: { wait_for_model: true }
            })
        });

        if (!response.ok) {
            throw new Error(`API request failed: ${response.status}`);
        }

        const result = await response.json();

        // Handle various response formats
        if (Array.isArray(result) && result.length > 0) {
            return {
                isInappropriate: result[0].label === "hate" || result[0].score > 0.7,
                confidence: result[0].score || 0
            };
        } else if (result.error) {
            console.error("API Error:", result.error);
            return { isInappropriate: false, confidence: 0 };
        } else {
            return { isInappropriate: false, confidence: 0 };
        }
    } catch (error) {
        console.error("Content moderation error:", error);
        // Default to allowing content if moderation fails
        return { isInappropriate: false, confidence: 0 };
    }
};



    // Resource Card Component
   
    const ResourceCard = ({ resource, onUpvote, onDownvote, onSave, isSaved, setCurrentPage, votingResources = {} }) => {
    if (!resource) return null;

    const {
        title = '',
        description = '',
        tags = [],
        upvotes = {},
        downvotes = {},
        postedBy = 'Anonymous',
        thumbnail = '',
        link = ''
    } = resource;

    const userId = auth.currentUser ? auth.currentUser.uid : null;
    const hasUpvoted = userId && resource.upvotes?.[userId];
    const hasDownvoted = userId && resource.downvotes?.[userId];
    const isVoting = votingResources[resource.id] || false;
    
    const [username, setUsername] = React.useState('Anonymous');
    const [showProfileModal, setShowProfileModal] = React.useState(false);
    const [currentProfileId, setCurrentProfileId] = React.useState(null);

    React.useEffect(() => {
    const fetchUsername = async () => {
        if (resource.postedBy && auth.currentUser) {
            try {
                const userRef = firebase.database().ref(`users/${resource.postedBy}`);
                const snapshot = await userRef.once('value');
                const userData = snapshot.val();
                if (userData && userData.username) {
                    setUsername(userData.username);
                }
            } catch (error) {
                console.error('Error fetching username:', error);
                setUsername('Anonymous');
            }
        }
    };
    
    fetchUsername();
}, [resource.postedBy]);


    const handleLinkClick = (e) => {
        e.stopPropagation();
        if (link) {
            window.open(link, '_blank', 'noopener,noreferrer');
        }
    };

    const renderVotingButtons = () => (
        <div className="flex items-center bg-[#21262D] rounded-lg overflow-hidden">
            <button 
                onClick={() => onUpvote(resource.id)}
                disabled={isVoting}
                className={`p-2 transition-colors duration-300 group flex items-center gap-1
                    ${hasUpvoted ? 'text-green-500 bg-green-500/10' : 'text-[#8B949E] hover:text-green-500 hover:bg-green-500/10'}
                    ${isVoting ? 'opacity-50 cursor-not-allowed' : ''}`}
            >
                <svg className="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <path d="M12 4v16m0-16L4 12m8-8l8 8" />
                </svg>
                <span className="text-sm">
                    {Object.keys(upvotes || {}).length}
                </span>
            </button>
            
            <button 
                onClick={() => onDownvote(resource.id)}
                disabled={isVoting}
                className={`p-2 transition-colors duration-300 group flex items-center gap-1
                    ${hasDownvoted ? 'text-red-500 bg-red-500/10' : 'text-[#8B949E] hover:text-red-500 hover:bg-red-500/10'}
                    ${isVoting ? 'opacity-50 cursor-not-allowed' : ''}`}
            >
                <svg className="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <path d="M12 20V4m0 16l-8-8m8 8l8-8" />
                </svg>
                <span className="text-sm">
                    {Object.keys(downvotes || {}).length}
                </span>
            </button>
        </div>
    );

    return (
        <div className={`${colors.bg.secondary} rounded-xl border ${colors.border} 
            hover:bg-[#1C2128] transition-all duration-300 group overflow-hidden`}>
            
            <div className="relative">
                {thumbnail ? (
                    <div className="w-full h-48 overflow-hidden">
                        <img
                            src={thumbnail}
                            alt={title}
                            className="w-full h-full object-cover object-center transform 
                                group-hover:scale-105 transition-transform duration-300"
                        />
                        <div className="absolute inset-0 bg-gradient-to-t from-[#1C2128] to-transparent opacity-60" />
                    </div>
                ) : (
                    <div className="h-2 bg-gradient-to-r from-[#58A6FF]/20 to-[#BD6AFF]/20" />
                )}
            </div>

            <div className="p-6 space-y-4">
                <div className="flex justify-between items-start gap-4">
                    <h3 className="text-lg font-semibold text-[#58A6FF] group-hover:text-[#58A6FF]/90 
                        transition-colors duration-300">
                        {title}
                    </h3>
                    <div className="flex items-center gap-2">
                        {renderVotingButtons()}
                        <button 
                            onClick={() => onSave(resource.id)}
                            className={`p-2 rounded-lg transition-colors duration-300
                                ${isSaved ? 'text-[#58A6FF] bg-[#58A6FF]/10' : 'text-[#8B949E] hover:text-[#58A6FF] hover:bg-[#58A6FF]/10'}`}
                        >
                            <svg className="w-5 h-5" viewBox="0 0 24 24" fill={isSaved ? "currentColor" : "none"} 
                                stroke="currentColor" strokeWidth="2">
                                <path strokeLinecap="round" strokeLinejoin="round" 
                                    d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z" />
                            </svg>
                        </button>
                    </div>
                </div>

                <p className={`${colors.text.secondary} leading-relaxed text-sm whitespace-pre-line`}>
                    {description}
                </p>

                <div className="flex flex-wrap gap-2">
                    {tags.map(tag => (
                        <span
                            key={tag}
                            className="px-3 py-1 rounded-full text-xs bg-[#21262D] text-[#58A6FF] 
                                border border-[#30363D] hover:border-[#58A6FF]/30 transition-colors duration-300"
                        >
                            {tag}
                        </span>
                    ))}
                </div>

                <div className="flex items-center justify-between pt-4 border-t border-[#30363D]">
                    <div className="flex items-center gap-4 text-sm">
                        <button
                            onClick={() => {
                                setCurrentProfileId(resource.postedBy);
                                setShowProfileModal(true);
                            }}
                            className={`${colors.text.secondary} hover:text-[#58A6FF] transition-colors duration-300 
                                flex items-center gap-1`}
                        >
                            <svg className="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                <path strokeLinecap="round" strokeLinejoin="round" 
                                    d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                            </svg>
                            {username}
                        </button>
                    </div>

                    {showProfileModal && (
                        <UserProfileModal 
                            userId={currentProfileId} 
                            onClose={() => setShowProfileModal(false)} 
                        />
                    )}

                    {link && (
                        <button
                            onClick={handleLinkClick}
                            className="flex items-center gap-2 px-4 py-2 bg-[#58A6FF] text-white rounded-lg 
                                hover:bg-[#58A6FF]/90 transition-all duration-300"
                        >
                            <span className="text-sm">View Resource</span>
                            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} 
                                    d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                            </svg>
                        </button>
                    )}
                </div>
            </div>
        </div>
    );
};



    // Quick Win Card Component
    const QuickWinCard = ({ onOverwhelm, currentTip }) => (
        <div className={`relative ${colors.bg.secondary} rounded-xl p-6 mb-8 ${colors.border} border backdrop-blur-xl 
            hover:bg-[#1C2128] transition-all duration-300`}>
            <div className="flex justify-between items-start">
                <div className="space-y-2">
                    <h3 className="text-sm font-medium text-[#58A6FF] flex items-center gap-2 opacity-80">
                        <span>âœ¨</span>Quick Win for Today
                    </h3>
                    <p className={`${colors.text.primary} text-lg leading-relaxed`}>
                        {currentTip}
                    </p>
                </div>
                <button
                    onClick={onOverwhelm}
                    className="px-4 py-2 rounded-full text-sm bg-[#21262D] text-[#58A6FF] hover:bg-[#2C323A] 
                        transition-all duration-300 border border-[#30363D] hover:border-[#58A6FF]/30"
                >
                    I'm Overwhelmed
                </button>
            </div>
        </div>
    );

    const OverwhelmModal = ({ onClose }) => {
        const [step, setStep] = React.useState(1);
        const [breathCount, setBreathCount] = React.useState(0);
        const [seconds, setSeconds] = React.useState(4);
        const [breathingPhase, setBreathingPhase] = React.useState('inhale'); // 'inhale' or 'exhale'

        React.useEffect(() => {
            if (step === 1 && breathCount < 3) {
                const timer = setInterval(() => {
                    if (seconds > 0) {
                        setSeconds(s => s - 1);
                    } else {
                        if (breathingPhase === 'inhale') {
                            setBreathingPhase('exhale');
                            setSeconds(4);
                        } else {
                            setBreathingPhase('inhale');
                            setSeconds(4);
                            setBreathCount(b => b + 1);
                        }
                    }
                }, 1000);
                return () => clearInterval(timer);
            }
        }, [step, breathCount, seconds, breathingPhase]);

        return (
            <div className="fixed inset-0 bg-gray-950/95 z-50 flex items-center justify-center p-4 backdrop-blur-xl">
                <div className="bg-gray-900 rounded-xl p-8 max-w-md w-full border border-purple-700/50">
                    {step === 1 && (
                        <div className="space-y-6">
                            <h3 className="text-xl font-semibold text-purple-300">Breathing Exercise</h3>
                            <div className="flex flex-col items-center">
                                <div className={`w-32 h-32 rounded-full border-4 
                                    ${breathingPhase === 'inhale' ? 'border-purple-500 scale-110' : 'border-pink-500 scale-100'}
                                    transition-all duration-1000 flex items-center justify-center`}>
                                    <span className="text-2xl font-bold text-purple-300">{seconds}</span>
                                </div>
                                <p className="mt-4 text-gray-300">
                                    {breathingPhase === 'inhale' ? 'Breathe In...' : 'Breathe Out...'}
                                </p>
                                <p className="text-sm text-gray-400 mt-2">
                                    {breathCount}/3 breaths completed
                                </p>
                            </div>
                            {breathCount >= 3 && (
                                <button
                                    onClick={() => setStep(2)}
                                    className="w-full bg-purple-600 text-white py-3 rounded-lg hover:bg-purple-700"
                                >
                                    Next: Grounding
                                </button>
                            )}
                        </div>
                    )}

                    {step === 2 && (
                        <div className="space-y-6">
                            <h3 className="text-xl font-semibold text-purple-300">Grounding Exercise</h3>
                            <div className="space-y-4">
                                <p className="text-gray-300">Name 3 things you can:</p>
                                <div className="space-y-2">
                                    <input 
                                        placeholder="See..."
                                        className="w-full p-3 bg-gray-800 rounded-lg border border-gray-700"
                                    />
                                    <input 
                                        placeholder="Hear..."
                                        className="w-full p-3 bg-gray-800 rounded-lg border border-gray-700"
                                    />
                                    <input 
                                        placeholder="Feel..."
                                        className="w-full p-3 bg-gray-800 rounded-lg border border-gray-700"
                                    />
                                </div>
                                <button
                                    onClick={() => setStep(3)}
                                    className="w-full bg-purple-600 text-white py-3 rounded-lg hover:bg-purple-700"
                                >
                                    Next: Small Task
                                </button>
                            </div>
                        </div>
                    )}

                    {step === 3 && (
                        <div className="space-y-6">
                            <h3 className="text-xl font-semibold text-purple-300">Choose One Small Task</h3>
                            <div className="space-y-3">
                                {[
                                    'Drink a glass of water',
                                    'Stretch for one minute',
                                    'Write down whats on your mind',
                                    'Clear one small space',
                                    'Take a 2-minute walk'
                                ].map(task => (
                                    <button
                                        key={task}
                                        onClick={() => {
                                            // Here we would log the completed task
                                            onClose();
                                        }}
                                        className="w-full text-left p-4 bg-gray-800 hover:bg-gray-700 rounded-lg transition-colors duration-300"
                                    >
                                        {task}
                                    </button>
                                ))}
                            </div>
                        </div>
                    )}

                    <button
                        onClick={onClose}
                        className="absolute top-4 right-4 text-gray-400 hover:text-gray-300"
                    >
                        âœ•
                    </button>
                </div>
            </div>
        );
    };

    // Search Bar Component
    const SearchBar = ({ value, onChange, onSubmit }) => (
    <div className="relative mb-8">
        <div className={`${colors.bg.secondary} rounded-xl p-6 border ${colors.border} backdrop-blur-xl`}>
            <h2 className={`text-xl font-medium ${colors.text.primary} mb-4`}>
                What are you trying to do today?
            </h2>
            <div className="relative">
                <input
                    type="text"
                    value={value}
                    onChange={onChange}
                    onKeyPress={(e) => {
                        if (e.key === 'Enter') {
                            onSubmit();
                        }
                    }}
                    className={`w-full p-4 pl-12 ${colors.bg.accent} rounded-lg border ${colors.border} 
                        ${colors.text.primary} placeholder-[#8B949E] focus:border-[#58A6FF]/30 
                        focus:bg-[#2C323A] transition-all duration-300`}
                    placeholder="E.g., I need to write a paper..."
                />
                <span className="absolute left-4 top-1/2 -translate-y-1/2 text-[#8B949E]">
                    <svg className="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                        <path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                </span>
            </div>
        </div>
    </div>
);

const DiscoverPage = ({ resources, onUpvote, onDownvote, onSave, savedResources, setCurrentPage, votingResources,
    user,
    setShowAuth,
    setIsLogin  }) => {
    const [activeFilter, setActiveFilter] = React.useState('all');
    const [selectedTags, setSelectedTags] = React.useState([]);
    const [sortOrder, setSortOrder] = React.useState('desc');
    const [dateRange, setDateRange] = React.useState('all');
    

    const predefinedTags = ['Productivity',
    'Study',
    'Focus',
    'Health',
    'Routine',
    'Work',
    'Mindfulness',
    'Time Management',];

    const filteredResources = React.useMemo(() => {
        if (!Array.isArray(resources)) return [];
        
        let filtered = [...resources];

        if (selectedTags.length > 0) {
            filtered = filtered.filter(resource => 
                resource.tags?.some(tag => selectedTags.includes(tag.toLowerCase()))
            );
        }

        if (dateRange !== 'all') {
            const now = Date.now();
            const ranges = {
                'today': 24 * 60 * 60 * 1000,
                'week': 7 * 24 * 60 * 60 * 1000,
                'month': 30 * 24 * 60 * 60 * 1000
            };
            filtered = filtered.filter(resource => 
                (now - resource.createdAt) <= ranges[dateRange]
            );
        }

        switch (activeFilter) {
            case 'trending':
                filtered.sort((a, b) => {
                    const aScore = ((a.upvotes?.length || 0) - (a.downvotes?.length || 0));
                    const bScore = ((b.upvotes?.length || 0) - (b.downvotes?.length || 0));
                    return sortOrder === 'desc' ? bScore - aScore : aScore - bScore;
                });
                break;
            case 'recent':
                filtered.sort((a, b) => 
                    sortOrder === 'desc' 
                        ? b.createdAt - a.createdAt 
                        : a.createdAt - b.createdAt
                );
                break;
            case 'popular':
                filtered.sort((a, b) => {
                    const aScore = (a.upvotes?.length || 0);
                    const bScore = (b.upvotes?.length || 0);
                    return sortOrder === 'desc' ? bScore - aScore : aScore - bScore;
                });
                break;
        }

        return filtered;
    }, [resources, activeFilter, selectedTags, sortOrder, dateRange]);

    return (
        <div className="space-y-6">
            <div className="sticky top-0 bg-[#0D1117] p-4 z-10">
                <div className="flex flex-col space-y-4">
                    {/* Main Filters Row */}
                    <div className="flex items-center justify-between">
                        <div className="flex gap-2">
                            {['All', 'Trending', 'Recent', 'Popular'].map(filter => (
                                <button
                                    key={filter}
                                    onClick={() => setActiveFilter(filter.toLowerCase())}
                                    className={`px-4 py-2 rounded-full text-sm ${
                                        activeFilter === filter.toLowerCase()
                                            ? 'bg-[#58A6FF] text-white'
                                            : 'bg-[#1C2333] text-gray-400 hover:bg-[#252D3F]'
                                    }`}
                                >
                                    {filter}
                                </button>
                            ))}
                        </div>

                        <div className="flex items-center gap-2">
                            <button
                                onClick={() => setSortOrder(prev => prev === 'desc' ? 'asc' : 'desc')}
                                className="p-2 rounded bg-[#1C2333] hover:bg-[#252D3F]"
                            >
                                <svg 
                                    className="w-4 h-4 text-gray-400" 
                                    fill="none" 
                                    stroke="currentColor" 
                                    viewBox="0 0 24 24"
                                >
                                    <path 
                                        strokeLinecap="round" 
                                        strokeLinejoin="round" 
                                        strokeWidth={2} 
                                        d={sortOrder === 'desc' ? "M19 9l-7 7-7-7" : "M5 15l7-7 7 7"} 
                                    />
                                </svg>
                            </button>

                            <select
                                value={dateRange}
                                onChange={(e) => setDateRange(e.target.value)}
                                className="bg-[#1C2333] text-gray-400 px-4 py-2 rounded appearance-none hover:bg-[#252D3F] outline-none"
                            >
                                <option value="all">All Time</option>
                                <option value="today">Today</option>
                                <option value="week">This Week</option>
                                <option value="month">This Month</option>
                            </select>
                        </div>
                    </div>

                    {/* Tags Row */}
                    {/* Tags Container */}
<div className="flex items-center overflow-x-auto scrollbar-hide py-2">
    <div className="flex gap-2 px-1">
        {predefinedTags.map(tag => (
            <button
                key={tag}
                onClick={() => setSelectedTags(prev => 
                    prev.includes(tag) 
                        ? prev.filter(t => t !== tag)
                        : [...prev, tag]
                )}
                className={`px-4 py-2 rounded-full text-sm whitespace-nowrap transition-all duration-300 ${
                    selectedTags.includes(tag)
                        ? 'bg-[#58A6FF]/20 text-[#58A6FF] border border-[#58A6FF]'
                        : 'bg-[#1C2333] text-gray-400 hover:bg-[#252D3F] border border-transparent'
                }`}
            >
                {tag}
            </button>
        ))}
    </div>
</div>
                </div>
            </div>

            {/* Resources Grid */}
            <div className="grid gap-4">
                {filteredResources.map(resource => (
                    <ResourceCard
                    key={resource.id}
                        resource={resource}
                        onUpvote={user ? onUpvote : () => setShowAuth(true)}
                        onDownvote={user ? onDownvote : () => setShowAuth(true)}
                        onSave={user ? onSave : () => setShowAuth(true)}
                        isSaved={savedResources.includes(resource.id)}
                        setCurrentPage={setCurrentPage}
                        votingResources={votingResources}
                    />
                ))}
            </div>
        </div>
    );
};


    const SuccessMessage = () => (
    <div className="fixed bottom-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg fade-in">
        ðŸŽ‰ Resource posted successfully!
    </div>
);

const ErrorMessage = ({ message }) => (
    <div className="fixed bottom-4 right-4 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg animate-shake">
        âŒ {message}
    </div>
);

const handleUpvote = async (resourceId) => {
  const userId = auth.currentUser.uid;
  const db = firebase.database();
  
  // Transaction ensures atomic updates
  await db.ref(`resources/${resourceId}`).transaction(resource => {
    if (resource) {
      // Remove from downvotes
      if (resource.downvotes?.[userId]) {
        delete resource.downvotes[userId];
      }
      // Toggle upvote
      resource.upvotes = resource.upvotes || {};
      resource.upvotes[userId] = !resource.upvotes[userId];
    }
    return resource;
  });
};


const handleDownvote = async (resourceId) => {
    if (!user) {
        alert('Please log in to downvote a resource.');
        return;
    }

    try {
        const resourceRef = firebase.database().ref(`resources/${resourceId}`);
        const snapshot = await resourceRef.once('value');
        const resource = snapshot.val();

        if (resource) {
            const upvotes = resource.upvotes || [];
            const downvotes = resource.downvotes || [];
            const userId = user.uid;

            // Check if user has already downvoted
            if (downvotes.includes(userId)) {
                // Remove downvote
                await resourceRef.update({
                    downvotes: downvotes.filter(id => id !== userId)
                });
            } else {
                // Add downvote and remove upvote if exists
                await resourceRef.update({
                    downvotes: [...downvotes, userId],
                    upvotes: upvotes.filter(id => id !== userId)
                });
            }

            // Refresh resources to update UI
            loadResources();
        }
    } catch (error) {
        console.error('Error downvoting resource:', error);
    }

    
};

const handleSaveResource = async (resourceId) => {
    if (!user) {
        alert('Please log in to save a resource.');
        return;
    }

    try {
        const userRef = firebase.database().ref(`users/${user.uid}/savedResources`);
        const snapshot = await userRef.once('value');
        const savedResources = snapshot.val() || [];

        if (!savedResources.includes(resourceId)) {
            // Add the resource to saved list
            await userRef.set([...savedResources, resourceId]);
            setSavedResources(prev => [...prev, resourceId]);
        } else {
            // Remove the resource from saved list
            const updatedSavedResources = savedResources.filter(id => id !== resourceId);
            await userRef.set(updatedSavedResources);
            setSavedResources(updatedSavedResources);
        }
    } catch (error) {
        console.error('Error saving resource:', error);
    }
};


const PostPage = ({ user, onPost }) => {
  const [formData, setFormData] = React.useState({
    title: '',
    description: '',
    tags: [],
    timeToComplete: '',
    progress: 0,
    thumbnail: null,
    link: '',
  });
  const [isLoading, setIsLoading] = React.useState(false);
  const [isSuccess, setIsSuccess] = React.useState(false);
  const [error, setError] = React.useState('');

  // Predefined tags
  const PREDEFINED_TAGS = [
    'Productivity',
    'Study',
    'Focus',
    'Health',
    'Routine',
    'Work',
    'Mindfulness',
    'Time Management',
  ];

  const handleFileChange = (e) => {
    const file = e.target.files[0];
    if (file) {
      setFormData({ ...formData, thumbnail: file });
    }
  };

  const handleTagChange = (tag) => {
    const updatedTags = formData.tags.includes(tag)
      ? formData.tags.filter((t) => t !== tag)
      : formData.tags.length < 3 
        ? [...formData.tags, tag] 
        : formData.tags;
    setFormData({ ...formData, tags: updatedTags });
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    setIsLoading(true);
    setError('');

    try {
        // Basic profanity check first
        const containsProfanity = /fuck|shit|ass|bitch/i.test(formData.title) || 
                                /fuck|shit|ass|bitch/i.test(formData.description);
        
        if (containsProfanity) {
            setError("Your post contains inappropriate language. Please revise and try again.");
            setIsLoading(false);
            return; // Stop execution here
        }

        // Only proceed with resource creation if content is clean
        let thumbnailUrl = '';
        if (formData.thumbnail) {
            const storageRef = storage.ref(`thumbnails/${formData.thumbnail.name}`);
            await storageRef.put(formData.thumbnail);
            thumbnailUrl = await storageRef.getDownloadURL();
        }

        const newResource = {
            title: formData.title,
            description: formData.description,
            tags: formData.tags,
            timeToComplete: formData.timeToComplete,
            progress: formData.progress,
            thumbnail: thumbnailUrl,
            link: formData.link,
            postedBy: user.uid,
            createdAt: firebase.database.ServerValue.TIMESTAMP,
            upvotes: {},
            downvotes: {},
            status: 'active'
        };

        const ref = firebase.database().ref('resources').push();
        await ref.set(newResource);
        
        // Reset form and show success
        setFormData({
            title: '',
            description: '',
            tags: [],
            timeToComplete: '',
            progress: 0,
            thumbnail: null,
            link: '',
        });

        setIsSuccess(true);
        setTimeout(() => setIsSuccess(false), 3000);
        onPost();
    } catch (error) {
        setError('Failed to post resource. Please try again.');
        console.error('Error posting resource:', error);
    } finally {
        setIsLoading(false);
    }
};




  return (
    <div className="max-w-2xl mx-auto space-y-6">
      <div className={`${colors.bg.secondary} rounded-xl p-6 border ${colors.border}`}>
        <h2 className={`text-xl font-semibold ${colors.text.primary} mb-6`}>
          Share a Resource
        </h2>
        
        <form onSubmit={handleSubmit} className="space-y-6">
          {/* Title */}
          <div className="space-y-2">
            <label className={`block text-sm font-medium ${colors.text.secondary}`}>
              Title
            </label>
            <input
              type="text"
              placeholder="E.g., Time Blocking Method for ADHD"
              value={formData.title}
              onChange={(e) => setFormData({ ...formData, title: e.target.value })}
              className={`w-full p-3 ${colors.bg.accent} rounded-lg border ${colors.border} 
                ${colors.text.primary} placeholder-[#8B949E] focus:border-[#58A6FF] focus:ring-1 focus:ring-[#58A6FF]
                transition-all duration-300`}
              required
            />
          </div>

          {/* Description */}
          <div className="space-y-2">
            <label className={`block text-sm font-medium ${colors.text.secondary}`}>
              Description
            </label>
            <textarea
              placeholder="Describe your strategy or resource..."
              value={formData.description}
              onChange={(e) => setFormData({ ...formData, description: e.target.value })}
              className={`w-full p-3 min-h-[120px] ${colors.bg.accent} rounded-lg border ${colors.border} 
                ${colors.text.primary} placeholder-[#8B949E] focus:border-[#58A6FF] focus:ring-1 focus:ring-[#58A6FF]
                transition-all duration-300`}
              required
            />
          </div>

          {/* Tags */}
          <div className="space-y-2">
            <label className={`block text-sm font-medium ${colors.text.secondary}`}>
              Tags (Select up to 3)
            </label>
            <div className="flex flex-wrap gap-2">
              {PREDEFINED_TAGS.map((tag) => (
                <button
                  key={tag}
                  type="button"
                  onClick={() => handleTagChange(tag)}
                  className={`px-3 py-1.5 rounded-full text-sm transition-all duration-300 ${
                    formData.tags.includes(tag)
                      ? 'bg-[#58A6FF] text-white'
                      : `${colors.bg.accent} ${colors.text.secondary} hover:bg-[#2C323A] border ${colors.border}`
                  }`}
                >
                  {tag}
                </button>
              ))}
            </div>
          </div>

          {/* Link */}
          <div className="space-y-2">
            <label className={`block text-sm font-medium ${colors.text.secondary}`}>
              Resource Link (Optional)
            </label>
            <input
              type="url"
              placeholder="https://..."
              value={formData.link}
              onChange={(e) => setFormData({ ...formData, link: e.target.value })}
              className={`w-full p-3 ${colors.bg.accent} rounded-lg border ${colors.border} 
                ${colors.text.primary} placeholder-[#8B949E] focus:border-[#58A6FF] focus:ring-1 focus:ring-[#58A6FF]
                transition-all duration-300`}
            />
          </div>

          {/* Thumbnail Upload */}
          <div className="space-y-2">
            <label className={`block text-sm font-medium ${colors.text.secondary}`}>
              Thumbnail Image (Optional)
            </label>
            <input
              type="file"
              accept="image/*"
              onChange={handleFileChange}
              className={`w-full p-3 ${colors.bg.accent} rounded-lg border ${colors.border} 
                ${colors.text.primary} file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0
                file:text-sm file:font-medium file:bg-[#58A6FF] file:text-white
                hover:file:bg-[#58A6FF]/90 transition-all duration-300`}
            />
          </div>

          {/* Submit Button */}
          <button
            type="submit"
            disabled={isLoading}
            className={`w-full p-3 bg-[#58A6FF] text-white rounded-lg hover:bg-[#58A6FF]/90 
              transition-all duration-300 flex items-center justify-center gap-2
              disabled:opacity-50 disabled:cursor-not-allowed`}
          >
            {isLoading ? (
              <div className="flex items-center gap-2">
                <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin" />
                <span>Posting...</span>
              </div>
            ) : (
              'Post Resource'
            )}
          </button>

          {error && (
            <div className="p-3 bg-red-500/10 border border-red-500/20 rounded-lg text-red-400 text-sm">
              {error}
            </div>
          )}
        </form>
      </div>
    </div>
  );
};

const Confetti = () => (
    <div className="fixed inset-0 z-50 pointer-events-none">
        {Array.from({ length: 100 }).map((_, i) => (
            <div
                key={i}
                className="absolute w-2 h-2 bg-yellow-400 rounded-full"
                style={{
                    left: `${Math.random() * 100}vw`,
                    top: `${Math.random() * 100}vh`,
                    animation: `confetti-fall ${Math.random() * 3 + 2}s linear`,
                }}
            />
        ))}
    </div>
);

function calculateRelevanceScore(resource, searchQuery) {
  if (!resource || !searchQuery) return 0;
  
  const query = searchQuery.toLowerCase();
  const words = query.split(' ').filter(word => word.length > 2);
  let score = 0;

  // Check title
  if (resource.title && resource.title.toLowerCase().includes(query)) {
    score += 3;
  }

  // Check description
  if (resource.description) {
    const description = resource.description.toLowerCase();
    words.forEach(function(word) {
      if (description.includes(word)) {
        score += 1;
      }
    });
  }

  // Check tags
  if (Array.isArray(resource.tags)) {
    words.forEach(function(word) {
      resource.tags.forEach(function(tag) {
        if (tag.toLowerCase().includes(word)) {
          score += 2;
        }
      });
    });
  }

  return score;
}


function searchResources(resources, query) {
  if (!query.trim() || !Array.isArray(resources)) {
    return resources;
  }

  // Score and filter resources
  const scoredResources = resources
    .map(function(resource) {
      return {
        resource: resource,
        score: calculateRelevanceScore(resource, query)
      };
    })
    .filter(function(item) {
      return item.score > 0;
    })
    .sort(function(a, b) {
      return b.score - a.score;
    });

  return scoredResources.map(function(item) {
    return item.resource;
  });
}

const AISuggestionsSection = ({ onSubmit, isLoading }) => {
  const [query, setQuery] = React.useState('');
  const [showExamples, setShowExamples] = React.useState(true);

  const examples = [
    "I need to focus while studying",
    "I keep procrastinating on important tasks",
    "I need help organizing my daily routine",
    "I get overwhelmed with big projects"
  ];

  return (
    <div className={`${colors.bg.secondary} rounded-xl p-6 border ${colors.border} mb-8`}>
      <div className="space-y-4">
        <div className="flex items-center gap-2">
          <span className="text-2xl">ðŸ¤–</span>
          <h2 className={`text-xl font-medium ${colors.text.primary}`}>
            AI Resource Finder
          </h2>
        </div>
        
        <p className={`${colors.text.secondary}`}>
          Describe what you're trying to achieve or what you're struggling with, 
          and I'll suggest personalized resources and strategies.
        </p>

        <div className="relative">
          <textarea
            value={query}
            onChange={(e) => setQuery(e.target.value)}
            placeholder="E.g., I need help breaking down large tasks into manageable pieces..."
            className={`w-full p-4 ${colors.bg.accent} rounded-lg border ${colors.border}
              ${colors.text.primary} placeholder-[#8B949E] focus:border-[#58A6FF]/30
              focus:bg-[#2C323A] transition-all duration-300 min-h-[100px]`}
          />
          
          <button
            onClick={() => onSubmit(query)}
            disabled={isLoading || !query.trim()}
            className={`mt-2 px-6 py-2 bg-[#58A6FF] text-white rounded-lg 
              hover:bg-[#58A6FF]/90 transition-all duration-300
              disabled:opacity-50 disabled:cursor-not-allowed
              flex items-center gap-2`}
          >
            {isLoading ? (
              <div className="flex items-center gap-2">
                <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin" />
                <span>Finding Resources...</span>
              </div>
            ) : (
              <div className="flex items-center gap-2">
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} 
                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
                <span>Find Resources</span>
              </div>
            )}
          </button>
        </div>

        {showExamples && (
          <div className="mt-4">
            <p className={`text-sm ${colors.text.secondary} mb-2`}>
              Try asking about:
            </p>
            <div className="flex flex-wrap gap-2">
              {examples.map((example) => (
                <button
                  key={example}
                  onClick={() => {
                    setQuery(example);
                    setShowExamples(false);
                  }}
                  className={`px-3 py-1 rounded-full text-sm 
                    bg-[#21262D] text-[#58A6FF] border border-[#30363D]
                    hover:bg-[#2C323A] transition-colors duration-300`}
                >
                  {example}
                </button>
              ))}
            </div>
          </div>
        )}
      </div>
    </div>
  );
};

const generateAvatar = async (prompt) => {
    const API_URL = "https://api-inference.huggingface.co/models/runwayml/stable-diffusion-v1-5";
    
    try {
        const response = await fetch(API_URL, {
            method: "POST",
            headers: {
                "Authorization": `Bearer ${HF_API_KEY}`,
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                inputs: `A minimalist avatar with ${prompt}, digital art style, flat design`,
                parameters: {
                    num_inference_steps: 50,
                    guidance_scale: 7.5,
                    width: 512,
                    height: 512
                }
            })
        });

        if (!response.ok) {
            throw new Error('Failed to generate avatar');
        }

        const blob = await response.blob();
        return URL.createObjectURL(blob);
    } catch (error) {
        console.error('Avatar generation error:', error);
        return null;
    }
};


const ProfilePage = ({ userId, onUpvote, onDownvote, onSave }) => {
    const [profileData, setProfileData] = React.useState(null);
    const [loading, setLoading] = React.useState(true);
    const [sharedResources, setSharedResources] = React.useState([]);
    const [error, setError] = React.useState('');
    const [showEditModal, setShowEditModal] = React.useState(false);
    const isOwnProfile = auth.currentUser?.uid === userId;

    // ADHD Types mapping
    const ADHD_TYPES = {
        inattentive: { label: 'Predominantly Inattentive', icon: 'ðŸ¤”' },
        hyperactive: { label: 'Predominantly Hyperactive-Impulsive', icon: 'âš¡' },
        combined: { label: 'Combined Type', icon: 'ðŸ”„' },
        recent: { label: 'Recently Diagnosed', icon: 'ðŸ“‹' },
        self: { label: 'Self-Diagnosed', icon: 'ðŸ”' },
        support: { label: 'Support Person', icon: 'ðŸ’' }
    };

    // Interest Tags mapping
    const INTEREST_TAGS = {
        study: { label: 'Study Skills', icon: 'ðŸ“š' },
        work: { label: 'Work Strategies', icon: 'ðŸ’¼' },
        time: { label: 'Time Management', icon: 'â°' },
        org: { label: 'Organization', icon: 'ðŸ“‹' },
        focus: { label: 'Focus Techniques', icon: 'ðŸŽ¯' },
        emotion: { label: 'Emotional Regulation', icon: 'ðŸŽ­' },
        sleep: { label: 'Sleep', icon: 'ðŸ˜´' },
        exercise: { label: 'Exercise', icon: 'ðŸƒâ€â™‚ï¸' },
        nutrition: { label: 'Nutrition', icon: 'ðŸ¥—' },
        medication: { label: 'Medication', icon: 'ðŸ’Š' },
        mindfulness: { label: 'Mindfulness', icon: 'ðŸ§˜â€â™‚ï¸' },
        tech: { label: 'Technology Tools', icon: 'ðŸ’»' }
    };

    const fetchProfileData = React.useCallback(async () => {
        if (!userId) return;

        try {
            const userRef = firebase.database().ref(`users/${userId}`);
            const resourcesRef = firebase.database().ref('resources');
            
            const userSnapshot = await userRef.once('value');
            const userData = userSnapshot.val();
            
            if (!userData) {
                setError('Profile not found');
                return;
            }
            
            setProfileData(userData);

            const resourcesSnapshot = await resourcesRef
                .orderByChild('postedBy')
                .equalTo(userId)
                .once('value');
            
            const resourcesData = resourcesSnapshot.val() || {};
            const formattedResources = Object.entries(resourcesData).map(([id, data]) => ({
                id,
                ...data,
                upvotes: data.upvotes || {},
                downvotes: data.downvotes || {}
            }));
            
            setSharedResources(formattedResources);
            setLoading(false);
        } catch (error) {
            setError('Error loading profile');
            console.error('Error fetching profile data:', error);
            setLoading(false);
        }
    }, [userId]);

    React.useEffect(() => {
        fetchProfileData();

        const userRef = firebase.database().ref(`users/${userId}`);
        const resourcesRef = firebase.database().ref('resources');

        const profileListener = userRef.on('value', (snapshot) => {
            const userData = snapshot.val();
            if (!userData) {
                setError('Profile not found');
                return;
            }
            setProfileData(userData);
        });

        const resourcesListener = resourcesRef
            .orderByChild('postedBy')
            .equalTo(userId)
            .on('value', (snapshot) => {
                const resourcesData = snapshot.val() || {};
                const formattedResources = Object.entries(resourcesData).map(([id, data]) => ({
                    id,
                    ...data,
                    upvotes: data.upvotes || {},
                    downvotes: data.downvotes || {}
                }));
                setSharedResources(formattedResources);
            });

        return () => {
            userRef.off('value', profileListener);
            resourcesRef.off('value', resourcesListener);
        };
    }, [userId, fetchProfileData]);

    const handleProfileUpdate = async () => {
        await fetchProfileData();
        setShowEditModal(false);
    };

    if (loading) {
        return <div className="flex justify-center py-8">
            <div className="w-8 h-8 border-4 border-[#58A6FF] border-t-transparent rounded-full animate-spin" />
        </div>;
    }

    if (error) {
        return <div className="text-red-500 text-center py-8">{error}</div>;
    }

    return (
        <div className="space-y-8 max-w-4xl mx-auto px-4">
            {/* Profile Header */}
            <div className={`${colors.bg.secondary} rounded-xl overflow-hidden`}>
                <div className="h-32 bg-gradient-to-r from-[#58A6FF]/20 to-[#BD6AFF]/20 relative">
                    <div className="absolute -bottom-16 left-8">
                        <div className="w-32 h-32 rounded-full border-4 border-[#161B22] overflow-hidden"
                            style={{ 
                                background: Array.isArray(profileData?.avatar_color) 
                                    ? `linear-gradient(135deg, ${profileData.avatar_color.join(', ')})` 
                                    : profileData?.avatar_color || '#58A6FF'
                            }}>
                            <div className="w-full h-full flex items-center justify-center">
                                <span className="text-4xl font-bold text-white">
                                    {profileData?.username?.charAt(0).toUpperCase()}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <div className="pt-20 px-8 pb-8">
                    <div className="flex justify-between items-start">
                        <div>
                            <h2 className={`text-2xl font-bold ${colors.text.primary}`}>
                                {profileData?.username}
                            </h2>
                            {profileData?.bio && (
                                <p className={`mt-2 ${colors.text.secondary}`}>
                                    {profileData.bio}
                                </p>
                            )}
                        </div>
                        {isOwnProfile && (
                            <button
                                onClick={() => setShowEditModal(true)}
                                className={`px-4 py-2 rounded-lg ${colors.bg.accent} 
                                    ${colors.text.secondary} hover:bg-[#2C323A] transition-all duration-300`}
                            >
                                Edit Profile
                            </button>
                        )}
                    </div>
                </div>
            </div>

            {/* Stats Grid */}
            <div className="grid grid-cols-3 gap-4">
                <div className={`${colors.bg.secondary} rounded-xl p-6 border ${colors.border}`}>
                    <h3 className={colors.text.secondary}>Resources Posted</h3>
                    <p className="text-2xl text-[#58A6FF]">{sharedResources.length}</p>
                </div>
                <div className={`${colors.bg.secondary} rounded-xl p-6 border ${colors.border}`}>
                    <h3 className={colors.text.secondary}>Followers</h3>
                    <p className="text-2xl text-[#58A6FF]">
                        {Object.keys(profileData?.followers || {}).length}
                    </p>
                </div>
                <div className={`${colors.bg.secondary} rounded-xl p-6 border ${colors.border}`}>
                    <h3 className={colors.text.secondary}>Following</h3>
                    <p className="text-2xl text-[#58A6FF]">
                        {Object.keys(profileData?.following || {}).length}
                    </p>
                </div>
            </div>

            {/* ADHD Types and Interests */}
            <div className="grid md:grid-cols-2 gap-6">
                {/* ADHD Types */}
                <div className={`${colors.bg.secondary} rounded-xl p-6 border ${colors.border}`}>
                    <h3 className={`text-lg font-semibold ${colors.text.primary} mb-4`}>
                        ADHD Journey
                    </h3>
                    <div className="space-y-2">
                        {profileData?.adhd_type?.map(type => (
                            <div 
                                key={type}
                                className="flex items-center gap-2 p-2 rounded-lg bg-[#21262D] text-[#58A6FF]"
                            >
                                <span className="text-xl">{ADHD_TYPES[type]?.icon}</span>
                                <span>{ADHD_TYPES[type]?.label}</span>
                            </div>
                        ))}
                        {(!profileData?.adhd_type || profileData.adhd_type.length === 0) && (
                            <p className={`${colors.text.secondary} italic`}>No ADHD type specified</p>
                        )}
                    </div>
                </div>

                {/* Areas of Interest */}
                <div className={`${colors.bg.secondary} rounded-xl p-6 border ${colors.border}`}>
                    <h3 className={`text-lg font-semibold ${colors.text.primary} mb-4`}>
                        Areas of Interest
                    </h3>
                    <div className="flex flex-wrap gap-2">
                        {profileData?.interests?.map(interest => (
                            <div 
                                key={interest}
                                className="flex items-center gap-2 px-3 py-1.5 rounded-full 
                                    bg-gradient-to-r from-[#58A6FF]/10 to-[#BD6AFF]/10 
                                    border border-[#58A6FF]/20 text-[#58A6FF]"
                            >
                                <span>{INTEREST_TAGS[interest]?.icon}</span>
                                <span className="text-sm">{INTEREST_TAGS[interest]?.label}</span>
                            </div>
                        ))}
                        {(!profileData?.interests || profileData.interests.length === 0) && (
                            <p className={`${colors.text.secondary} italic`}>No interests specified</p>
                        )}
                    </div>
                </div>
            </div>

            {/* Shared Resources */}
            <div className="space-y-4">
                <h3 className={`text-lg font-semibold ${colors.text.primary}`}>
                    Shared Resources
                </h3>
                <div className="grid gap-4">
                    {sharedResources.map(resource => (
                        <ResourceCard
                            key={resource.id}
                            resource={resource}
                            onUpvote={onUpvote}
                            onDownvote={onDownvote}
                            onSave={onSave}
                            setCurrentPage={() => {}}
                        />
                    ))}
                    {sharedResources.length === 0 && (
                        <p className={`${colors.text.secondary} text-center py-8 italic`}>
                            No resources shared yet
                        </p>
                    )}
                </div>
            </div>

            {showEditModal && (
                <EditProfileModal
                    user={auth.currentUser}
                    profileData={profileData}
                    onClose={() => setShowEditModal(false)}
                    onUpdate={handleProfileUpdate}
                />
            )}
        </div>
    );
};

const EditProfileModal = ({ user, profileData, onClose, onUpdate }) => {
    const [formData, setFormData] = React.useState({
        username: profileData?.username || '',  // This needs profileData.username, not optional chaining
        bio: profileData.bio || '',
        adhd_type: profileData.adhd_type || [],
        interests: profileData.interests || [],
        avatar_color: profileData.avatar_color || ['#58A6FF', '#4B91F1']  // Should match the gradient format
    });
    const [loading, setLoading] = React.useState(false);
    const [error, setError] = React.useState('');

    const ADHD_TYPES = [
        { id: 'inattentive', label: 'Predominantly Inattentive', icon: 'ðŸ¤”' },
        { id: 'hyperactive', label: 'Predominantly Hyperactive-Impulsive', icon: 'âš¡' },
        { id: 'combined', label: 'Combined Type', icon: 'ðŸ”„' },
        { id: 'recent', label: 'Recently Diagnosed', icon: 'ðŸ“‹' },
        { id: 'self', label: 'Self-Diagnosed', icon: 'ðŸ”' },
        { id: 'support', label: 'Support Person', icon: 'ðŸ’' }
    ];

    const INTEREST_TAGS = [
        { id: 'study', label: 'Study Skills', icon: 'ðŸ“š' },
        { id: 'work', label: 'Work Strategies', icon: 'ðŸ’¼' },
        { id: 'time', label: 'Time Management', icon: 'â°' },
        { id: 'org', label: 'Organization', icon: 'ðŸ“‹' },
        { id: 'focus', label: 'Focus Techniques', icon: 'ðŸŽ¯' },
        { id: 'emotion', label: 'Emotional Regulation', icon: 'ðŸŽ­' },
        { id: 'sleep', label: 'Sleep', icon: 'ðŸ˜´' },
        { id: 'exercise', label: 'Exercise', icon: 'ðŸƒâ€â™‚ï¸' },
        { id: 'nutrition', label: 'Nutrition', icon: 'ðŸ¥—' },
        { id: 'medication', label: 'Medication', icon: 'ðŸ’Š' },
        { id: 'mindfulness', label: 'Mindfulness', icon: 'ðŸ§˜â€â™‚ï¸' },
        { id: 'tech', label: 'Technology Tools', icon: 'ðŸ’»' }
    ];

    const AVATAR_GRADIENTS = [
        { id: 'blue', colors: ['#58A6FF', '#4B91F1'], label: 'Ocean Blue' },
        { id: 'purple', colors: ['#BD6AFF', '#9B51E0'], label: 'Royal Purple' },
        { id: 'green', colors: ['#3FB950', '#2EA043'], label: 'Forest Green' },
        { id: 'orange', colors: ['#F7B955', '#F0883E'], label: 'Sunset Orange' },
        { id: 'pink', colors: ['#FF69B4', '#E84B8A'], label: 'Rose Pink' },
        { id: 'teal', colors: ['#39C5BB', '#20B2AA'], label: 'Teal Wave' }
    ];

    const handleSubmit = async (e) => {
    e.preventDefault();
    setLoading(true);
    setError('');

    try {
        if (!formData.username.trim()) {
            throw new Error('Username is required');
        }

        if (formData.username.length < 3) {
            throw new Error('Username must be at least 3 characters');
        }

        if (formData.username !== profileData.username) {
            const usersRef = firebase.database().ref('users');
            const snapshot = await usersRef
                .orderByChild('username')
                .equalTo(formData.username)
                .once('value');
            
            if (snapshot.exists()) {
                throw new Error('Username is already taken');
            }

            // Update username in all resources posted by this user
            const resourcesRef = firebase.database().ref('resources');
            const resourcesSnapshot = await resourcesRef
                .orderByChild('postedBy')
                .equalTo(user.uid)
                .once('value');
            
            const updates = {};
            resourcesSnapshot.forEach(resourceSnap => {
                updates[`resources/${resourceSnap.key}/postedBy`] = formData.username;
            });

            // Update both user profile and resources
            await firebase.database().ref().update({
                [`users/${user.uid}`]: {
                    ...formData,
                    updated_at: firebase.database.ServerValue.TIMESTAMP
                },
                ...updates
            });
        } else {
            // Just update user profile if username hasn't changed
            await firebase.database().ref(`users/${user.uid}`).update({
                ...formData,
                updated_at: firebase.database.ServerValue.TIMESTAMP
            });
        }

        onUpdate();
        onClose();
    } catch (error) {
        setError(error.message);
    } finally {
        setLoading(false);
    }
};


    return (
        <div className="fixed inset-0 bg-[#0D1117]/95 z-50 flex items-center justify-center p-4 backdrop-blur-xl">
            <div className={`${colors.bg.secondary} rounded-xl p-8 max-w-2xl w-full border ${colors.border} relative`}>
                {/* Header */}
                <div className="flex justify-between items-center mb-6">
                    <h2 className={`text-xl font-semibold ${colors.text.primary}`}>
                        Edit Profile
                    </h2>
                    <button 
                        onClick={onClose}
                        className={`${colors.text.secondary} hover:text-white transition-colors duration-300`}
                    >
                        âœ•
                    </button>
                </div>

                <div className="space-y-6 max-h-[70vh] overflow-y-auto px-2">
                    {/* Avatar Section */}
                    <div className="text-center">
                        <div className="w-24 h-24 mx-auto relative group">
                            <div className="absolute inset-0 bg-gradient-to-r from-[#58A6FF]/20 to-[#BD6AFF]/20 rounded-full blur-xl transition-all duration-300 group-hover:blur-2xl" />
                            <div 
                                className="relative w-full h-full rounded-full flex items-center justify-center"
                                style={{ 
                                    background: Array.isArray(formData.avatar_color)
                                        ? `linear-gradient(135deg, ${formData.avatar_color.join(', ')})`
                                        : formData.avatar_color
                                }}
                            >
                                <span className="text-3xl font-bold text-white">
                                    {formData.username.charAt(0).toUpperCase()}
                                </span>
                            </div>
                        </div>

                        <div className="flex flex-wrap justify-center gap-2 mt-4">
                            {AVATAR_GRADIENTS.map(({ id, colors, label }) => (
                                <button
                                    key={id}
                                    onClick={() => setFormData({ ...formData, avatar_color: colors })}
                                    className={`group relative p-1 rounded-full transition-transform hover:scale-110
                                        ${JSON.stringify(formData.avatar_color) === JSON.stringify(colors) 
                                            ? 'ring-2 ring-white/50 scale-110' 
                                            : ''}`}
                                    title={label}
                                >
                                    <div className="w-8 h-8 rounded-full"
                                        style={{ background: `linear-gradient(135deg, ${colors.join(', ')})` }}
                                    />
                                    <span className="absolute -bottom-6 left-1/2 -translate-x-1/2 text-xs text-white/75 
                                        opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">
                                        {label}
                                    </span>
                                </button>
                            ))}
                        </div>
                    </div>

                    {/* Profile Info */}
                    <div className="space-y-4">
                        <div>
                            <label className={`block text-sm font-medium ${colors.text.secondary} mb-2`}>
                                Username
                            </label>
                            <input
                                type="text"
                                value={formData.username}
                                onChange={(e) => setFormData({ ...formData, username: e.target.value })}
                                className={`w-full p-3 ${colors.bg.accent} rounded-lg border ${colors.border} 
                                    ${colors.text.primary} focus:border-[#58A6FF] focus:ring-2 focus:ring-[#58A6FF]/20`}
                                placeholder="Choose a username"
                            />
                        </div>

                        <div>
                            <label className={`block text-sm font-medium ${colors.text.secondary} mb-2`}>
                                Bio
                            </label>
                            <textarea
                                value={formData.bio}
                                onChange={(e) => setFormData({ ...formData, bio: e.target.value })}
                                className={`w-full p-3 min-h-[100px] ${colors.bg.accent} rounded-lg border ${colors.border} 
                                    ${colors.text.primary} focus:border-[#58A6FF] focus:ring-2 focus:ring-[#58A6FF]/20`}
                                placeholder="Tell us about yourself..."
                            />
                        </div>
                    </div>

                    {/* ADHD Types */}
                    <div>
                        <label className={`block text-sm font-medium ${colors.text.secondary} mb-4`}>
                            ADHD Type (Select all that apply)
                        </label>
                        <div className="grid grid-cols-2 gap-2">
                            {ADHD_TYPES.map(type => (
                                <button
                                    key={type.id}
                                    type="button"
                                    onClick={() => {
                                        const types = formData.adhd_type.includes(type.id)
                                            ? formData.adhd_type.filter(t => t !== type.id)
                                            : [...formData.adhd_type, type.id];
                                        setFormData({ ...formData, adhd_type: types });
                                    }}
                                    className={`p-3 rounded-lg border text-left transition-colors
                                        ${formData.adhd_type.includes(type.id)
                                            ? 'bg-[#58A6FF]/10 border-[#58A6FF] text-[#58A6FF]'
                                            : `${colors.bg.accent} ${colors.border} ${colors.text.secondary} hover:bg-[#2C323A]`
                                        }`}
                                >
                                    <span className="flex items-center gap-2">
                                        {type.icon} {type.label}
                                    </span>
                                </button>
                            ))}
                        </div>
                    </div>

                    {/* Interests */}
                    <div>
                        <label className={`block text-sm font-medium ${colors.text.secondary} mb-4`}>
                            Areas of Interest
                        </label>
                        <div className="flex flex-wrap gap-2">
                            {INTEREST_TAGS.map(tag => (
                                <button
                                    key={tag.id}
                                    type="button"
                                    onClick={() => {
    const updatedInterests = formData.interests.includes(tag.id)
        ? formData.interests.filter(t => t !== tag.id)
        : [...formData.interests, tag.id];
    setFormData({ ...formData, interests: updatedInterests });
}}

                                    className={`px-4 py-2 rounded-full text-sm transition-all duration-300
                                        ${formData.interests.includes(tag.id)
                                            ? 'bg-gradient-to-r from-[#58A6FF] to-[#BD6AFF] text-white'
                                            : `${colors.bg.accent} ${colors.text.secondary} hover:bg-[#2C323A] border ${colors.border}`
                                        }`}
                                >
                                    <span className="flex items-center gap-2">
                                        {tag.icon} {tag.label}
                                    </span>
                                </button>
                            ))}
                        </div>
                    </div>
                </div>

                {/* Error Message */}
                {error && (
                    <div className="mt-4 p-3 bg-red-500/10 border border-red-500/20 rounded-lg text-red-400">
                        {error}
                    </div>
                )}

                {/* Actions */}
                <div className="flex justify-end gap-3 mt-6 pt-6 border-t border-gray-800">
                    <button
                        onClick={onClose}
                        className={`px-4 py-2 rounded-lg ${colors.bg.accent} ${colors.text.secondary}
                            hover:bg-[#2C323A] transition-all duration-300`}
                    >
                        Cancel
                    </button>
                    <button
                        onClick={handleSubmit}
                        disabled={loading}
                        className="px-4 py-2 bg-[#58A6FF] text-white rounded-lg hover:bg-[#4B91F1]
                            transition-all duration-300 flex items-center gap-2
                            disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        {loading ? (
                            <div className="flex items-center gap-2">
                                <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin" />
                                <span>Saving...</span>
                            </div>
                        ) : (
                            <span>Save Changes</span>
                        )}
                    </button>
                </div>
            </div>
        </div>
    );
};


// Modified handleVote function with rate limiting
const handleVote = async (resourceId, voteType) => {
  if (!auth.currentUser) {
    setShowAuth(true);
    return;
  }

  const userId = auth.currentUser.uid;


  setVotingResources(prev => ({
    ...prev,
    [resourceId]: true
  }));

  try {
    const resourceRef = firebase.database().ref(`resources/${resourceId}`);
    await resourceRef.transaction((resource) => {
      if (!resource) return null;
      
      resource.upvotes = resource.upvotes || {};
      resource.downvotes = resource.downvotes || {};
      
      const hasUpvoted = resource.upvotes[userId];
      const hasDownvoted = resource.downvotes[userId];
      
      delete resource.upvotes[userId];
      delete resource.downvotes[userId];
      
      if (voteType === 'upvote' && !hasUpvoted) {
        resource.upvotes[userId] = true;
      } else if (voteType === 'downvote' && !hasDownvoted) {
        resource.downvotes[userId] = true;
      }
      
      return resource;
    });
  } catch (error) {
    console.error('Error updating vote:', error);
  } finally {
    setVotingResources(prev => ({
      ...prev,
      [resourceId]: false
    }));
  }
};


const UnauthorizedProfilePage = ({ setShowAuth, setIsLogin }) => {
  return (
    <div className="flex flex-col items-center justify-center space-y-6 p-8">
      <div className={`${colors.bg.secondary} rounded-xl p-6 border ${colors.border} w-full max-w-md text-center`}>
        <div className="w-16 h-16 bg-[#58A6FF]/10 rounded-full flex items-center justify-center mx-auto mb-4">
          <svg className="w-8 h-8 text-[#58A6FF]" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
          </svg>
        </div>
        
        <h2 className={`text-xl font-semibold ${colors.text.primary} mb-4`}>
          Sign in to View Profile
        </h2>
        
        <p className={`${colors.text.secondary} mb-6`}>
          Create an account to track your progress, save resources, and get personalized recommendations.
        </p>
        
        <div className="space-y-3">
          <button
            onClick={() => {
              setIsLogin(true);
              setShowAuth(true);
            }}
            className="w-full px-4 py-2 bg-[#58A6FF] text-white rounded-lg hover:bg-[#58A6FF]/90 transition-all duration-300"
          >
            Login
          </button>
          
          <button
            onClick={() => {
              setIsLogin(false);
              setShowAuth(true);
            }}
            className="w-full px-4 py-2 border border-[#58A6FF] text-[#58A6FF] rounded-lg hover:bg-[#58A6FF]/10 transition-all duration-300"
          >
            Create Account
          </button>
        </div>
      </div>
    </div>
  );
};

const UnauthorizedPostPage = ({ setShowAuth, setIsLogin }) => {
  return (
    <div className="space-y-6 max-w-2xl mx-auto">
      <div className={`${colors.bg.secondary} rounded-xl p-8 border ${colors.border}`}>
        <div className="text-center space-y-6">
          {/* Icon */}
          <div className="w-20 h-20 bg-[#58A6FF]/10 rounded-full flex items-center justify-center mx-auto">
            <svg 
              className="w-10 h-10 text-[#58A6FF]" 
              viewBox="0 0 24 24" 
              fill="none" 
              stroke="currentColor"
              strokeWidth="2"
            >
              <path strokeLinecap="round" strokeLinejoin="round" d="M12 4v16m8-8H4" />
            </svg>
          </div>

          {/* Title */}
          <h2 className={`text-2xl font-semibold ${colors.text.primary}`}>
            Share Your ADHD Strategies
          </h2>

          {/* Description */}
          <p className={`${colors.text.secondary} max-w-md mx-auto`}>
            Join our community to share your experiences, strategies, and resources that help manage ADHD. Your insights could make a difference for others.
          </p>

          {/* Benefits List */}
          <div className="grid gap-4 text-left mt-8 mb-8">
            {[
              {
                icon: "ðŸŽ¯",
                title: "Share Your Success",
                description: "Help others by sharing strategies that worked for you"
              },
              {
                icon: "ðŸ’«",
                title: "Build Reputation",
                description: "Get recognition for your helpful contributions"
              },
              {
                icon: "ðŸ¤",
                title: "Join the Community",
                description: "Connect with others who understand your experiences"
              }
            ].map((benefit) => (
              <div 
                key={benefit.title} 
                className={`${colors.bg.accent} p-4 rounded-lg border ${colors.border} flex items-start gap-4`}
              >
                <span className="text-2xl">{benefit.icon}</span>
                <div>
                  <h3 className={`font-medium ${colors.text.primary}`}>
                    {benefit.title}
                  </h3>
                  <p className={`${colors.text.secondary} text-sm`}>
                    {benefit.description}
                  </p>
                </div>
              </div>
            ))}
          </div>

          {/* Action Buttons */}
          <div className="flex flex-col sm:flex-row gap-3 justify-center">
            <button
              onClick={() => {
                setIsLogin(false);
                setShowAuth(true);
              }}
              className="px-6 py-3 bg-[#58A6FF] text-white rounded-lg hover:bg-[#58A6FF]/90 transition-all duration-300 flex items-center justify-center gap-2"
            >
              <span>Create Account</span>
              <svg 
                className="w-4 h-4" 
                fill="none" 
                stroke="currentColor" 
                viewBox="0 0 24 24"
              >
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M14 5l7 7m0 0l-7 7m7-7H3" />
              </svg>
            </button>
            
            <button
              onClick={() => {
                setIsLogin(true);
                setShowAuth(true);
              }}
              className="px-6 py-3 border border-[#58A6FF] text-[#58A6FF] rounded-lg hover:bg-[#58A6FF]/10 transition-all duration-300"
            >
              Already have an account? Log in
            </button>
          </div>
        </div>
      </div>
    </div>
  );
};

const UnauthorizedAISection = ({ setShowAuth, setIsLogin }) => {
  return (
    <div className={`${colors.bg.secondary} rounded-xl p-6 border ${colors.border} mb-8`}>
      <div className="space-y-4">
        <div className="flex items-center gap-2">
          <span className="text-2xl">ðŸ¤–</span>
          <h2 className={`text-xl font-medium ${colors.text.primary}`}>
            AI Resource Finder
          </h2>
        </div>
        
        <p className={`${colors.text.secondary}`}>
          Sign in to unlock personalized AI-powered resources and strategies tailored to your needs.
        </p>

        <div className="flex gap-3">
          <button
            onClick={() => {
              setIsLogin(true);
              setShowAuth(true);
            }}
            className="px-6 py-2 bg-[#58A6FF] text-white rounded-lg hover:bg-[#58A6FF]/90 transition-all duration-300"
          >
            Login to Access
          </button>
          
          <button
            onClick={() => {
              setIsLogin(false);
              setShowAuth(true);
            }}
            className="px-6 py-2 border border-[#58A6FF] text-[#58A6FF] rounded-lg hover:bg-[#58A6FF]/10 transition-all duration-300"
          >
            Sign Up
          </button>
        </div>
      </div>
    </div>
  );
};

const migratePostedByToUsernames = async () => {
    const db = firebase.database();
    
    try {
        // Get all resources
        const resourcesSnapshot = await db.ref('resources').once('value');
        const resources = resourcesSnapshot.val();
        
        // Get all users
        const usersSnapshot = await db.ref('users').once('value');
        const users = usersSnapshot.val();
        
        // Create UID to username mapping
        const uidToUsername = {};
        Object.entries(users).forEach(([uid, userData]) => {
            uidToUsername[uid] = userData.username;
        });
        
        // Update each resource's postedBy field
        const updates = {};
        Object.entries(resources).forEach(([resourceId, resource]) => {
            if (resource.postedBy && uidToUsername[resource.postedBy]) {
                updates[`resources/${resourceId}/postedBy`] = uidToUsername[resource.postedBy];
            }
        });
        
        // Perform batch update
        await db.ref().update(updates);
        
    } catch (error) {
        console.error('Migration error:', error);
    }
};


const handlePostResource = async (resourceData) => {
  if (!user) {
    alert('Please log in to post a resource.');
    return;
  }


  setIsPosting(true);
  setPostError('');

  try {
    const titleCheck = await validateContent(resourceData.title);
    const descriptionCheck = await validateContent(resourceData.description);

    if (titleCheck.isInappropriate || descriptionCheck.isInappropriate) {
      throw new Error("Content contains inappropriate language");
    }

    const newResource = {
      ...resourceData,
      postedBy: user.uid,
      createdAt: firebase.database.ServerValue.TIMESTAMP,
    };

    const ref = firebase.database().ref('resources').push();
    await ref.set(newResource);

    setPostSuccess(true);
    setTimeout(() => setPostSuccess(false), 3000);
    await loadResources();
  } catch (error) {
    setPostError('Failed to post resource. Please try again.');
    console.error('Error posting resource:', error);
  } finally {
    setIsPosting(false);
  }
};

const OnboardingModal = ({ user, onComplete }) => {
    const [step, setStep] = React.useState(1);
    const [formData, setFormData] = React.useState({
        username: '',
        bio: '',
        adhd_type: [],
        interests: [],
        avatar_color: '#58A6FF',
    });
    const [loading, setLoading] = React.useState(false);
    const [animatingStep, setAnimatingStep] = React.useState(false);

    const ADHD_TYPES = [
        { id: 'inattentive', label: 'Predominantly Inattentive', icon: 'ðŸ¤”' },
        { id: 'hyperactive', label: 'Predominantly Hyperactive-Impulsive', icon: 'âš¡' },
        { id: 'combined', label: 'Combined Type', icon: 'ðŸ”„' },
        { id: 'recent', label: 'Recently Diagnosed', icon: 'ðŸ“‹' },
        { id: 'self', label: 'Self-Diagnosed', icon: 'ðŸ”' },
        { id: 'support', label: 'Support Person', icon: 'ðŸ’' }
    ];

    const INTEREST_TAGS = [
        { id: 'study', label: 'Study Skills', icon: 'ðŸ“š' },
        { id: 'work', label: 'Work Strategies', icon: 'ðŸ’¼' },
        { id: 'time', label: 'Time Management', icon: 'â°' },
        { id: 'org', label: 'Organization', icon: 'ðŸ“‹' },
        { id: 'focus', label: 'Focus Techniques', icon: 'ðŸŽ¯' },
        { id: 'emotion', label: 'Emotional Regulation', icon: 'ðŸŽ­' },
        { id: 'sleep', label: 'Sleep', icon: 'ðŸ˜´' },
        { id: 'exercise', label: 'Exercise', icon: 'ðŸƒâ€â™‚ï¸' },
        { id: 'nutrition', label: 'Nutrition', icon: 'ðŸ¥—' },
        { id: 'medication', label: 'Medication', icon: 'ðŸ’Š' },
        { id: 'mindfulness', label: 'Mindfulness', icon: 'ðŸ§˜â€â™‚ï¸' },
        { id: 'tech', label: 'Technology Tools', icon: 'ðŸ’»' }
    ];

    const AVATAR_GRADIENTS = [
        { id: 'blue', colors: ['#58A6FF', '#4B91F1'], label: 'Ocean Blue' },
        { id: 'purple', colors: ['#BD6AFF', '#9B51E0'], label: 'Royal Purple' },
        { id: 'green', colors: ['#3FB950', '#2EA043'], label: 'Forest Green' },
        { id: 'orange', colors: ['#F7B955', '#F0883E'], label: 'Sunset Orange' },
        { id: 'pink', colors: ['#FF69B4', '#E84B8A'], label: 'Rose Pink' },
        { id: 'teal', colors: ['#39C5BB', '#20B2AA'], label: 'Teal Wave' }
    ];

    const handleStepChange = (direction) => {
        setAnimatingStep(true);
        setTimeout(() => {
            setStep(step + direction);
            setAnimatingStep(false);
        }, 300);
    };

    const handleSubmit = async () => {
        setLoading(true);
        try {
            await firebase.database().ref(`users/${user.uid}`).update({
                ...formData,
                onboarding_completed: true,
                updated_at: firebase.database.ServerValue.TIMESTAMP
            });
            onComplete();
        } catch (error) {
            console.error('Error saving profile:', error);
        } finally {
            setLoading(false);
        }
    };

    const StepIndicator = () => (
        <div className="flex items-center justify-between mb-12 relative">
            <div className="absolute left-0 right-0 top-1/2 -translate-y-1/2">
                <div className="h-0.5 bg-gradient-to-r from-[#58A6FF]/20 to-[#BD6AFF]/20" />
            </div>
            {[1, 2, 3].map((stepNumber) => (
                <div key={stepNumber} className="relative z-10">
                    <div 
                        className={`w-12 h-12 rounded-full flex items-center justify-center transition-all duration-300
                            ${step === stepNumber 
                                ? 'bg-gradient-to-r from-[#58A6FF] to-[#BD6AFF] scale-110' 
                                : step > stepNumber 
                                    ? 'bg-[#58A6FF]/20 text-[#58A6FF]' 
                                    : colors.bg.accent}`}
                    >
                        <span className={`text-lg font-medium
                            ${step === stepNumber ? 'text-white' : colors.text.secondary}`}>
                            {step > stepNumber ? 'âœ“' : stepNumber}
                        </span>
                    </div>
                    <p className={`absolute -bottom-6 left-1/2 -translate-x-1/2 text-sm whitespace-nowrap
                        ${step === stepNumber ? colors.text.primary : colors.text.secondary}`}>
                        {stepNumber === 1 ? 'Your Profile' :
                         stepNumber === 2 ? 'ADHD Type' :
                         'Interests'}
                    </p>
                </div>
            ))}
        </div>
    );

    const renderStep = () => {
        const contentClass = `transition-all duration-300 ${animatingStep ? 'opacity-0 translate-y-4' : 'opacity-100 translate-y-0'}`;

        switch (step) {
            case 1:
                return (
                    <div className={contentClass}>
                        <div className="text-center mb-8">
                            <h2 className={`text-2xl font-bold ${colors.text.primary} mb-2`}>
                                Welcome to Solace! ðŸ‘‹
                            </h2>
                            <p className={`${colors.text.secondary} text-lg`}>
                                Let's create your personalized profile
                            </p>
                        </div>

                        <div className="mb-8">
                            <div className="w-32 h-32 mx-auto relative group">
                                <div className="absolute inset-0 bg-gradient-to-r from-[#58A6FF]/20 to-[#BD6AFF]/20 rounded-full blur-xl transition-all duration-300 group-hover:blur-2xl" />
                                <div 
                                    className="relative w-full h-full rounded-full flex items-center justify-center overflow-hidden"
                                    style={{ 
                                        background: `linear-gradient(135deg, ${formData.avatar_color})`,
                                    }}
                                >
                                    <span className="text-4xl font-bold text-white">
                                        {formData.username.charAt(0).toUpperCase() || '?'}
                                    </span>
                                </div>
                            </div>
                            
                            <div className="flex flex-wrap justify-center gap-2 mt-4">
                                {AVATAR_GRADIENTS.map(({ id, colors, label }) => (
                                    <button
                                        key={id}
                                        onClick={() => setFormData({ ...formData, avatar_color: colors })}
                                        className={`group relative p-1 rounded-full transition-transform hover:scale-110
                                            ${formData.avatar_color === colors ? 'ring-2 ring-white/50 scale-110' : ''}`}
                                        title={label}
                                    >
                                        <div className="w-8 h-8 rounded-full"
                                            style={{ background: `linear-gradient(135deg, ${colors.join(', ')})` }}
                                        />
                                        <span className="absolute -bottom-6 left-1/2 -translate-x-1/2 text-xs text-white/75 
                                            opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">
                                            {label}
                                        </span>
                                    </button>
                                ))}
                            </div>
                        </div>

                        <div className="space-y-6">
                            <div>
                                <label className={`block text-sm font-medium ${colors.text.secondary} mb-2`}>
                                    Choose a Username
                                </label>
                                <input
                                    type="text"
                                    value={formData.username}
                                    onChange={(e) => setFormData({ ...formData, username: e.target.value })}
                                    className={`w-full p-4 ${colors.bg.accent} rounded-lg border ${colors.border} 
                                        ${colors.text.primary} focus:border-[#58A6FF] focus:ring-2 focus:ring-[#58A6FF]/20
                                        transition-all duration-300`}
                                    placeholder="What should we call you?"
                                />
                            </div>

                            <div>
                                <label className={`block text-sm font-medium ${colors.text.secondary} mb-2`}>
                                    Your Bio (Optional)
                                </label>
                                <textarea
                                    value={formData.bio}
                                    onChange={(e) => setFormData({ ...formData, bio: e.target.value })}
                                    className={`w-full p-4 min-h-[120px] ${colors.bg.accent} rounded-lg border ${colors.border} 
                                        ${colors.text.primary} focus:border-[#58A6FF] focus:ring-2 focus:ring-[#58A6FF]/20
                                        transition-all duration-300`}
                                    placeholder="Tell us a bit about yourself..."
                                />
                            </div>
                        </div>
                    </div>
                );

            case 2:
                return (
                    <div className={contentClass}>
                        <div className="text-center mb-8">
                            <h2 className={`text-2xl font-bold ${colors.text.primary} mb-2`}>
                                Your ADHD Journey ðŸŒŸ
                            </h2>
                            <p className={`${colors.text.secondary} text-lg`}>
                                Help us understand your experience better
                            </p>
                        </div>

                        <div className="grid grid-cols-2 gap-3">
                            {ADHD_TYPES.map(({ id, label, icon }) => (
                                <button
                                    key={id}
                                    onClick={() => {
                                        const types = formData.adhd_type.includes(id)
                                            ? formData.adhd_type.filter(t => t !== id)
                                            : [...formData.adhd_type, id];
                                        setFormData({ ...formData, adhd_type: types });
                                    }}
                                    className={`p-4 rounded-xl border text-left transition-all duration-300 group
                                        ${formData.adhd_type.includes(id)
                                            ? 'bg-gradient-to-r from-[#58A6FF]/10 to-[#BD6AFF]/10 border-[#58A6FF]'
                                            : `${colors.bg.accent} ${colors.border} hover:bg-[#2C323A]`
                                        }`}
                                >
                                    <div className="flex items-center gap-3">
                                        <span className="text-2xl">{icon}</span>
                                        <span className={`font-medium ${
                                            formData.adhd_type.includes(id)
                                                ? 'text-[#58A6FF]'
                                                : colors.text.primary
                                        }`}>
                                            {label}
                                        </span>
                                    </div>
                                </button>
                            ))}
                        </div>
                    </div>
                );

            case 3:
                return (
                    <div className={contentClass}>
                        <div className="text-center mb-8">
                            <h2 className={`text-2xl font-bold ${colors.text.primary} mb-2`}>
                                What Interests You? ðŸŒˆ
                            </h2>
                            <p className={`${colors.text.secondary} text-lg`}>
                                Select topics you'd like to explore
                            </p>
                        </div>

                        <div className="flex flex-wrap gap-2">
                            {INTEREST_TAGS.map(({ id, label, icon }) => (
                                <button
                                    key={id}
                                    onClick={() => {
                                        const interests = formData.interests.includes(id)
                                        if (formData.interests.includes(id)) {
    interests = formData.interests.filter(function(t) {
        return t !== id;
    });
} else {
    interests = formData.interests.concat([id]);
}
                                        setFormData({ ...formData, interests: interests });
                                    }}
                                    className={`px-4 py-2 rounded-full text-sm transition-all duration-300 group
                                        ${formData.interests.includes(id)
                                            ? 'bg-gradient-to-r from-[#58A6FF] to-[#BD6AFF] text-white'
                                            : `${colors.bg.accent} ${colors.text.secondary} hover:bg-[#2C323A] border ${colors.border}`
                                        }`}
                                >
                                    <span className="flex items-center gap-2">
                                        {icon} {label}
                                    </span>
                                </button>
                            ))}
                        </div>

                        <div className="mt-8 pt-8 border-t border-gray-800">
                            <h3 className={`${colors.text.primary} font-medium mb-2`}>
                                Ready to get started?
                            </h3>
                            <p className={`${colors.text.secondary} text-sm`}>
                                We'll use your preferences to personalize your experience and suggest relevant resources.
                            </p>
                        </div>
                    </div>
                );
        }
    };

    return (
        <div className="fixed inset-0 bg-[#0D1117]/95 z-50 flex items-center justify-center p-4 backdrop-blur-xl">
            <div className={`${colors.bg.secondary} rounded-2xl p-8 max-w-2xl w-full border ${colors.border}
                shadow-2xl shadow-[#58A6FF]/5`}>
                
                <StepIndicator />
                
                {/* Content */}
                <div className="min-h-[400px]">
                    {renderStep()}
                </div>

                {/* Navigation */}
                <div className="flex justify-between mt-8 pt-8 border-t border-gray-800">
                    {step > 1 && (
                        <button
                            onClick={() => handleStepChange(-1)}
                            className={`px-6 py-3 rounded-xl ${colors.bg.accent} ${colors.text.secondary}
                                hover:bg-[#2C323A] transition-all duration-300 flex items-center gap-2`}
                        >
                            <svg className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
                            </svg>
                            Back
                        </button>
                    )}
                    
                    <button
                        onClick={() => {
                            if (step < 3) {
                                handleStepChange(1);
                            } else {
                                handleSubmit();
                            }
                        }}
                        disabled={loading || (step === 1 && !formData.username)}
                        className={`px-6 py-3 rounded-xl ml-auto flex items-center gap-2
                            ${step === 3
                                ? 'bg-gradient-to-r from-[#58A6FF] to-[#BD6AFF] hover:from-[#4B91F1] hover:to-[#9B51E0]'
                                : 'bg-[#58A6FF] hover:bg-[#4B91F1]'
                            } text-white transition-all duration-300
                            disabled:opacity-50 disabled:cursor-not-allowed group`}
                    >
                    {loading ? (
    <div className="flex items-center gap-2">
        <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin" />
        <span>Saving...</span>
    </div>
) : (
    <div className="flex items-center gap-2">
        <span>{step === 3 ? 'Complete Setup' : 'Next'}</span>
        <svg
            className="w-5 h-5 transition-transform duration-300 group-hover:translate-x-1"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
        >
            <path
                strokeLinecap="round"
                strokeLinejoin="round"
                strokeWidth={2}
                d="M9 5l7 7-7 7"
            />
        </svg>
    </div>
)}
                    </button>
                </div>

                {/* Progress Dots */}
                <div className="absolute bottom-4 left-1/2 -translate-x-1/2 flex gap-2">
                    {[1, 2, 3].map((dot) => (
                        <div
                            key={dot}
                            className={`w-2 h-2 rounded-full transition-all duration-300 ${
                                step === dot 
                                    ? 'bg-[#58A6FF] scale-125' 
                                    : 'bg-gray-600'
                            }`}
                        />
                    ))}
                </div>
            </div>
        </div>
    );
};

const MainContentWrapper = ({ children }) => {
    return (
        <div className="min-h-screen pb-24"> {/* Added pb-24 for navigation spacing */}
            <main className="max-w-4xl mx-auto px-4">
                {children}
            </main>
        </div>
    );
};

const UserProfileModal = ({ userId, onClose }) => {
    const [profileData, setProfileData] = React.useState(null);
    const [loading, setLoading] = React.useState(true);
    const [error, setError] = React.useState('');
    const isOwnProfile = auth.currentUser?.uid === userId;

    React.useEffect(() => {
        const fetchProfileData = async () => {
            try {
                const userSnapshot = await firebase.database().ref(`users/${userId}`).once('value');
                const userData = userSnapshot.val();
                
                if (!userData) {
                    throw new Error('Profile not found');
                }
                setProfileData(userData);
                
                // Check if current user is following this profile
                if (auth.currentUser) {
                    const followingSnapshot = await firebase.database()
                        .ref(`users/${auth.currentUser.uid}/following/${userId}`)
                        .once('value');
                    setIsFollowing(followingSnapshot.exists());
                }
            } catch (error) {
                setError('Error loading profile');
            } finally {
                setLoading(false);
            }
        };

        fetchProfileData();
    }, [userId]);
    const [isFollowing, setIsFollowing] = React.useState(false);

    const handleFollowUser = async () => {
        if (!auth.currentUser) return;
        
        try {
            const currentUserId = auth.currentUser.uid;
            const followerRef = firebase.database().ref(`users/${userId}/followers/${currentUserId}`);
            const followingRef = firebase.database().ref(`users/${currentUserId}/following/${userId}`);
            
            if (isFollowing) {
                // Unfollow
                await followerRef.remove();
                await followingRef.remove();
                setIsFollowing(false);
            } else {
                // Follow
                await followerRef.set(true);
                await followingRef.set(true);
                setIsFollowing(true);
            }
            
            // Refresh profile data
            const snapshot = await firebase.database().ref(`users/${userId}`).once('value');
            setProfileData(snapshot.val());
        } catch (error) {
            console.error('Error following/unfollowing user:', error);
        }
    };

    return (
        <div className="fixed inset-0 bg-black/75 z-50 flex items-center justify-center p-4">
            <div className={`${colors.bg.secondary} rounded-xl p-8 max-w-md w-full relative`}>
                <button 
                    onClick={onClose}
                    className="absolute top-4 right-4 text-gray-400 hover:text-white"
                >
                    âœ•
                </button>

                {loading ? (
                    <div className="flex justify-center py-8">
                        <div className="w-8 h-8 border-4 border-[#58A6FF] border-t-transparent rounded-full animate-spin" />
                    </div>
                ) : error ? (
                    <div className="text-red-500 text-center py-8">{error}</div>
                ) : (
                    <div className="space-y-6">
                        <div className="flex items-center gap-4">
                            <div 
                                className="w-16 h-16 rounded-full"
                                style={{ 
                                    background: Array.isArray(profileData.avatar_color) 
                                        ? `linear-gradient(135deg, ${profileData.avatar_color.join(', ')})` 
                                        : profileData.avatar_color || '#58A6FF'
                                }}
                            >
                                <div className="w-full h-full flex items-center justify-center">
                                    <span className="text-2xl font-bold text-white">
                                        {profileData.username?.charAt(0).toUpperCase()}
                                    </span>
                                </div>
                            </div>
                            <div>
                                <h2 className="text-xl font-bold text-white">{profileData.username}</h2>
                                {profileData.bio && (
                                    <p className="text-gray-400 mt-1">{profileData.bio}</p>
                                )}
                            </div>
                        </div>

                        <div className="grid grid-cols-2 gap-4">
                            <div className="text-center p-4 bg-gray-800 rounded-lg">
                                <div className="text-[#58A6FF] text-xl font-bold">
                                    {profileData.resourcesShared || 0}
                                </div>
                                <div className="text-gray-400 text-sm">Resources Shared</div>
                            </div>
                            <div className="text-center p-4 bg-gray-800 rounded-lg">
                                <div className="text-[#58A6FF] text-xl font-bold">
                                    {Object.keys(profileData.followers || {}).length}
                                </div>
                                <div className="text-gray-400 text-sm">Followers</div>
                            </div>
                            {!isOwnProfile && auth.currentUser && (
    <button
        onClick={handleFollowUser}
        className={`px-4 py-2 rounded-lg transition-all duration-300
            ${isFollowing 
                ? `${colors.bg.accent} ${colors.text.secondary}`
                : 'bg-[#58A6FF] text-white'}`}
    >
        {isFollowing ? 'Following' : 'Follow'}
    </button>
)}
                        </div>
                        
                    </div>
                )}
            </div>
        </div>
    );
};


    // Main App Component
    function App() {
      const [user, setUser] = React.useState(null);
    const [showAuth, setShowAuth] = React.useState(false);
    const [isLogin, setIsLogin] = React.useState(true);
    const [currentPage, setCurrentPage] = React.useState('main');
    const [resources, setResources] = React.useState([]);
    const [savedResources, setSavedResources] = React.useState([]);
    const [searchQuery, setSearchQuery] = React.useState('');
    const [aiSuggestedResources, setAISuggestedResources] = React.useState([]);
    const [isOverwhelmed, setIsOverwhelmed] = React.useState(false);
    const [currentTip, setCurrentTip] = React.useState(QUICK_TIPS[0]);
    const [userProfile, setUserProfile] = React.useState(null);
    const [loading, setLoading] = React.useState(true);
    const [isPosting, setIsPosting] = React.useState(false);
    const [postSuccess, setPostSuccess] = React.useState(false);
    const [postError, setPostError] = React.useState('');
    const handleUpvote = (resourceId) => handleVote(resourceId, 'upvote');
    const handleDownvote = (resourceId) => handleVote(resourceId, 'downvote');
    const [showOnboarding, setShowOnboarding] = React.useState(false);
    const [votingResources, setVotingResources] = React.useState({});

    const handleAISearch = async (query) => {
  if (!query.trim() || !user) return;
  

  setLoading(true);
  try {
    const suggestions = await fetchAIResources(query);
    setAISuggestedResources(suggestions);
  } catch (error) {
    console.error('Search error:', error);
    setAISuggestedResources([{
      id: 'error-1',
      title: 'Error Getting Suggestions',
      description: 'Failed to get AI suggestions. Please try again.',
      timeToComplete: 'N/A',
      tags: ['Error'],
      progress: 0,
      postedBy: 'System',
      likes: 0,
      liked: false
    }]);
  } finally {
    setLoading(false);
  }
};

    // Load resources from Firebase Realtime Database
    const loadResources = async () => {
    try {
        const snapshot = await firebase.database().ref('resources').once('value');
        const resourcesData = [];

        snapshot.forEach((childSnapshot) => {
            const resource = childSnapshot.val();
            if (resource) {
                resourcesData.push({
                    id: childSnapshot.key,
                    ...resource,
                    upvotes: resource.upvotes || [],
                    downvotes: resource.downvotes || [],
                });
            }
        });

        setResources(resourcesData);
    } catch (error) {
        console.error('Error loading resources:', error);
        setResources([]); // Set empty array on error
    }
};

    // Handle resource posting
    const handlePostResource = async (resourceData) => {
        if (!user) {
            alert('Please log in to post a resource.');
            return;
        }

        setIsPosting(true);
        setPostError('');

        try {
            const newResource = {
                ...resourceData,
                postedBy: user.uid,
                createdAt: firebase.database.ServerValue.TIMESTAMP,
            };

            const ref = firebase.database().ref('resources').push();
            await ref.set(newResource);

            setPostSuccess(true);
            setTimeout(() => setPostSuccess(false), 3000); // Hide success message after 3 seconds

            // Refresh resources after posting
            await loadResources();
        } catch (error) {
            setPostError('Failed to post resource. Please try again.');
            console.error('Error posting resource:', error);
        } finally {
            setIsPosting(false);
        }
    };



    // Handle saving resources
    const handleSaveResource = async (resourceId) => {
        if (!user) {
            alert('Please log in to save a resource.');
            return;
        }

        try {
            const userRef = firebase.database().ref(`users/${user.uid}/savedResources`);
            const snapshot = await userRef.once('value');
            const savedResources = snapshot.val() || [];

            if (!savedResources.includes(resourceId)) {
                await userRef.set([...savedResources, resourceId]);
                setSavedResources(prev => [...prev, resourceId]);
            } else {
                // If the resource is already saved, remove it
                const updatedSavedResources = savedResources.filter(id => id !== resourceId);
                await userRef.set(updatedSavedResources);
                setSavedResources(updatedSavedResources);
            }
        } catch (error) {
            console.error('Error saving resource:', error);
        }
    };

    const handleCompleteResource = async (resourceId) => {
    if (!user) {
        alert('Please log in to mark a resource as completed.');
        return;
    }

    try {
        const userRef = firebase.database().ref(`users/${user.uid}`);
        const snapshot = await userRef.once('value');
        const userData = snapshot.val();
        const updatedResourcesCompleted = (userData.resourcesCompleted || 0) + 1;

        await userRef.update({ resourcesCompleted: updatedResourcesCompleted });

        // Optionally, you can also mark the resource as completed in the resources table
        const resourceRef = firebase.database().ref(`resources/${resourceId}`);
        await resourceRef.update({ completed: true });

        // Update local state
        setResources(prevResources =>
            prevResources.map(res =>
                res.id === resourceId ? { ...res, completed: true } : res
            )
        );
    } catch (error) {
        console.error('Error completing resource:', error);
    }
};

    const fetchAIResources = async function(searchQuery) {
  try {
    console.log('Fetching AI resources for query:', searchQuery);
    
    const prompt = `You are an ADHD coach helping the user who says: "${searchQuery}"

Give 3 practical strategies to help them. Each strategy should be short but specific.`;

    const response = await fetch(
      'https://api-inference.huggingface.co/models/tiiuae/falcon-7b-instruct',
      {
        method: 'POST',
        headers: {
          'Authorization': 'Bearer ' + HF_API_KEY,
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          inputs: prompt,
          parameters: {
            max_new_tokens: 250,
            temperature: 0.7,
            top_p: 0.9,
            do_sample: true
          }
        })
      }
    );

    const data = await response.json();
    console.log('Raw AI response:', data);
    
    // Check if model is loading
    if (data.error && data.error.includes('loading')) {
      console.log('Model is loading, waiting to retry...');
      await new Promise(resolve => setTimeout(resolve, 2000));
      return fetchAIResources(searchQuery);
    }

    if (!response.ok) {
      throw new Error(data.error || 'Failed to get AI suggestions');
    }

    // Get the generated text
    const responseText = Array.isArray(data) ? data[0].generated_text : data.generated_text;
    console.log('Generated text:', responseText);

    // If we got an empty or invalid response, return defaults
    if (!responseText || responseText.length < 10) {
      return getDefaultStrategies();
    }

    // Try to extract strategies from the response
    const strategies = [];
    const lines = responseText.split('\n').filter(function(line) { return line.trim(); });
    let currentStrategy = null;

    for (let i = 0; i < lines.length; i++) {
      const line = lines[i].trim();
      
      // Look for numbers at start of line to identify new strategies
      if (/^[1-3][.:]/.test(line) || /Strategy \d+:/i.test(line)) {
        if (currentStrategy) {
          strategies.push(currentStrategy);
        }
        currentStrategy = {
          id: 'ai-' + strategies.length + '-' + Date.now(),
          title: line.replace(/^[1-3][.:]|Strategy \d+:/i, '').trim(),
          description: '',
          timeToComplete: '5-10 minutes',
          tags: ['AI Suggested', 'ADHD-friendly'],
          progress: 0,
          postedBy: 'AI Assistant',
          likes: 0,
          liked: false
        };
      } else if (currentStrategy) {
        currentStrategy.description += (currentStrategy.description ? '\n' : '') + line;
      }
    }

    if (currentStrategy) {
      strategies.push(currentStrategy);
    }

    // If we got good strategies, clean them up and return
    if (strategies.length > 0) {
      return strategies.map(function(strategy) {
        return {
          ...strategy,
          // Clean up empty titles
          title: strategy.title || 'Strategy',
          // Clean up empty descriptions
          description: strategy.description || 'Focus on one task at a time and break it into smaller steps.'
        };
      });
    }

    // If we couldn't parse strategies, try a simpler split
    const simpleStrategies = responseText
      .split(/\d\.|\n\n/)
      .filter(function(text) { return text.trim(); })
      .slice(0, 3)
      .map(function(text, index) {
        const lines = text.trim().split('\n');
        return {
          id: 'ai-' + index + '-' + Date.now(),
          title: 'Strategy ' + (index + 1),
          description: lines.join('\n'),
          timeToComplete: '5-10 minutes',
          tags: ['AI Suggested', 'ADHD-friendly'],
          progress: 0,
          postedBy: 'AI Assistant',
          likes: 0,
          liked: false
        };
      });

    // If we got at least one strategy, pad with defaults if needed
    if (simpleStrategies.length > 0) {
      while (simpleStrategies.length < 3) {
        const defaults = getDefaultStrategies();
        simpleStrategies.push(defaults[simpleStrategies.length]);
      }
      return simpleStrategies;
    }

    // If all else fails, return defaults
    return getDefaultStrategies();

  } catch (error) {
    console.error('AI Error:', error);
    return getDefaultStrategies();
  }
};

const handleVote = async (resourceId, voteType) => {
    if (!auth.currentUser) {
      setShowAuth(true);
      return;
    }

    const userId = auth.currentUser.uid;
    const resourceRef = firebase.database().ref(`resources/${resourceId}`);

    // Add to voting state to show immediate feedback
    setVotingResources(prev => ({
      ...prev,
      [resourceId]: true
    }));

    try {
      await resourceRef.transaction((resource) => {
        if (!resource) return null;

        // Initialize vote objects if they don't exist
        resource.upvotes = resource.upvotes || {};
        resource.downvotes = resource.downvotes || {};

        const hasUpvoted = resource.upvotes[userId];
        const hasDownvoted = resource.downvotes[userId];

        // Remove existing votes
        delete resource.upvotes[userId];
        delete resource.downvotes[userId];

        // Add new vote if it's not a toggle-off of the same type
        if (voteType === 'upvote' && !hasUpvoted) {
          resource.upvotes[userId] = true;
        } else if (voteType === 'downvote' && !hasDownvoted) {
          resource.downvotes[userId] = true;
        }

        return resource;
      });
    } catch (error) {
      console.error('Error updating vote:', error);
    } finally {
      // Remove from voting state
      setVotingResources(prev => ({
        ...prev,
        [resourceId]: false
      }));
    }
  };

// Memoize the resource loading functions
const loadUserData = React.useCallback(async (userId) => {
    try {
        const snapshot = await firebase.database().ref(`users/${userId}`).once('value');
        const userData = snapshot.val();
        setUserProfile(userData || { username: 'User', resourcesShared: 0, resourcesCompleted: 0 });
    } catch (error) {
        console.error('Error loading user data:', error);
    }
}, []);

const handleResourceSubmit = async (resourceData) => {
    try {
        // Check title and description
        const titleCheck = await validateContent(resourceData.title);
        const descriptionCheck = await validateContent(resourceData.description);

        if (titleCheck.isInappropriate || descriptionCheck.isInappropriate) {
            throw new Error("Content contains inappropriate language");
        }

        // Add pending status
        const newResource = {
            ...resourceData,
            status: 'pending',
            moderationScore: Math.max(titleCheck.confidence, descriptionCheck.confidence),
            createdAt: firebase.database.ServerValue.TIMESTAMP
        };

        // Save to pending resources
        await firebase.database().ref('pendingResources').push(newResource);
        
    } catch (error) {
        console.error('Moderation error:', error);
        throw error;
    }
};


// Update useEffect to load resources immediately
React.useEffect(() => {
    loadResources();
}, []); // Empty dependency array means this runs once on mount

// Fix the useEffect hooks with proper dependencies
React.useEffect(() => {
    const unsubscribe = auth.onAuthStateChanged(async (user) => {
        setUser(user);
        if (user) {
            // Add rate limit cleanup here
            
            const userSnapshot = await firebase.database().ref(`users/${user.uid}`).once('value');
            const userData = userSnapshot.val() || {};
            
            if (!userData.onboarding_completed) {
                setShowOnboarding(true);
            }
            
            loadUserData(user.uid);
        } else {
            setUserProfile(null);
        }
        setLoading(false);
    });
    return () => unsubscribe();
}, []);

    React.useEffect(() => {
    const resourcesRef = firebase.database().ref('resources');
    
    // Set up real-time listener for all resources
    const handleResourceUpdate = (snapshot) => {
        const updatedResources = [];
        snapshot.forEach((child) => {
            updatedResources.push({
                id: child.key,
                ...child.val(),
            });
        });
        setResources(updatedResources);
    };

    resourcesRef.on('value', handleResourceUpdate);

    // Cleanup listener on unmount
    return () => resourcesRef.off('value', handleResourceUpdate);
}, []);

React.useEffect(() => {
    const interval = setInterval(() => {
        setCurrentTip(prev => {
            const currentIndex = QUICK_TIPS.indexOf(prev);
            return QUICK_TIPS[(currentIndex + 1) % QUICK_TIPS.length];
        });
    }, 10000);
    return () => clearInterval(interval);
}, [QUICK_TIPS]); // Added QUICK_TIPS as dependency

// Memoize the renderContent function
const renderContent = () => {
    if (loading) return <LoadingSpinner />;

    if (currentPage === 'profile' && !user) {
        return <UnauthorizedProfilePage setShowAuth={setShowAuth} setIsLogin={setIsLogin} />;
    }

    switch (currentPage) {
        case 'main':
            return (
                <div>
                    <QuickWinCard
                        currentTip={currentTip}
                        onOverwhelm={() => setIsOverwhelmed(true)}
                    />
                    
                    {user ? (
                        <AISuggestionsSection
                            onSubmit={handleAISearch}
                            isLoading={loading}
                        />
                    ) : (
                        <UnauthorizedAISection 
                            setShowAuth={setShowAuth} 
                            setIsLogin={setIsLogin} 
                        />
                    )}

                    {aiSuggestedResources.length > 0 && user && (
                        <div className="space-y-4 mb-8">
                            <h3 className={'text-lg font-medium ' + colors.text.primary}>
                                AI Suggested Strategies:
                            </h3>
                            {aiSuggestedResources.map((resource) => (
                                <ResourceCard
                                key={resource.id}
                                resource={resource}
                                onUpvote={handleUpvote}
                                onDownvote={handleDownvote}
                                onSave={handleSaveResource}
                                isSaved={savedResources.includes(resource.id)}
                                setCurrentPage={setCurrentPage}
                                votingResources={votingResources}
                                />
                            ))}
                        </div>
                    )}

                    <div className="space-y-4">
                        <h3 className={'text-lg font-medium ' + colors.text.primary}>
                            Community Resources
                        </h3>
                        {resources
                            .filter((resource) => {
                                if (!resource || !searchQuery) return true;
                                const query = searchQuery.toLowerCase();
                                return (
                                    (resource.title || '').toLowerCase().includes(query) ||
                                    (resource.description || '').toLowerCase().includes(query)
                                );
                            })
                            .map((resource) => (
                                <ResourceCard
                                    key={resource.id}
                                    resource={resource}
                                    onUpvote={user ? handleUpvote : () => setShowAuth(true)}
                                    onDownvote={user ? handleDownvote : () => setShowAuth(true)}
                                    onSave={user ? handleSaveResource : () => setShowAuth(true)}
                                    isSaved={savedResources.includes(resource.id)}
                                    setCurrentPage={setCurrentPage}
                                    votingResources={votingResources}
                                />
                            ))}
                    </div>
                </div>
            );

        case 'discover':
            return (
                <DiscoverPage
                resources={resources}
                    onUpvote={handleUpvote}
                    onDownvote={handleDownvote}
                    onSave={handleSaveResource}
                    savedResources={savedResources}
                    setCurrentPage={setCurrentPage}
                    votingResources={votingResources}
                    user={user}
                    setShowAuth={setShowAuth}
                    setIsLogin={setIsLogin}
                />
            );

        case 'post':
            return user ? (
                <PostPage
                    user={user}
                    onPost={loadResources}
                />
            ) : (
                <UnauthorizedPostPage 
                    setShowAuth={setShowAuth} 
                    setIsLogin={setIsLogin}
                    resources={resources}
                    onUpvote={() => setShowAuth(true)}
                    onDownvote={() => setShowAuth(true)}
                    onSave={() => setShowAuth(true)}
                    savedResources={[]}
                    setCurrentPage={setCurrentPage}
                />
            );

        case 'profile':
            return user ? (
                <ProfilePage
                userId={user.uid}
                    userProfile={userProfile}
                    savedResources={savedResources}
                    onUpvote={handleUpvote}
                    onDownvote={handleDownvote}
                    onSave={handleSaveResource}
                />
            ) : (
                <UnauthorizedProfilePage setShowAuth={setShowAuth} setIsLogin={setIsLogin} />
            );

            {showEditModal && (
    <EditProfileModal
        user={auth.currentUser}
        profileData={profileData}
        onClose={() => setShowEditModal(false)}
        onUpdate={handleProfileUpdate}
    />
)}

        default:
            return null;
    }
};

return (
        <div className={`min-h-screen ${colors.bg.primary}`}>
            <header className="relative overflow-hidden">
                <div className="absolute inset-0 bg-gradient-to-r from-[#58A6FF]/5 to-[#BD6AFF]/5 blur-xl" />
                <div className="relative max-w-4xl mx-auto px-4 py-6">
                    <div className="flex justify-between items-center">
<div className="flex items-center">
  <img 
    src="./solace-logo-1.jpg" 
    alt="Solace Logo"
    className="h-10 w-auto" // Adjust height/width as needed
  />
</div>

                        {user ? (
                            <button
                                onClick={() => auth.signOut()}
                                className={`px-4 py-2 ${colors.text.secondary} hover:text-[#58A6FF]`}
                            >
                                Sign Out
                            </button>
                        ) : (
                            <div className="space-x-4">
                                <button
                                    onClick={() => {
                                        setIsLogin(true);
                                        setShowAuth(true);
                                    }}
                                    className="px-4 py-2 text-[#58A6FF] hover:text-[#58A6FF]/80"
                                >
                                    Login
                                </button>
                                <button
                                    onClick={() => {
                                        setIsLogin(false);
                                        setShowAuth(true);
                                    }}
                                    className="px-4 py-2 bg-[#58A6FF] text-white rounded-lg hover:bg-[#58A6FF]/90"
                                >
                                    Sign Up
                                </button>
                            </div>
                        )}
                    </div>
                </div>
            </header>

            <main className="relative max-w-4xl mx-auto px-4 py-6 space-y-6">
                {renderContent()}
            </main>

            <Navigation currentPage={currentPage} setCurrentPage={setCurrentPage} />

            {showAuth && (
                <AuthModal
                    onClose={() => setShowAuth(false)}
                    isLogin={isLogin}
                />
            )}

            {isOverwhelmed && (
                <OverwhelmModal
                    onClose={() => setIsOverwhelmed(false)}
                    user={user}
                />
            )}

            {isPosting && <LoadingSpinner />}
            {postSuccess && <SuccessMessage />}
            {postError && <ErrorMessage message={postError} />}

            {showOnboarding && (
        <OnboardingModal
            user={user}
            onComplete={() => {
                setShowOnboarding(false);
                loadUserData(user.uid);
            }}
        />
    )}
        </div>
    );
}

    // Render the app
    ReactDOM.createRoot(document.getElementById('root')).render(
    <ErrorBoundary>
        <App />
    </ErrorBoundary>
);
    </script>
</body>
</html>
